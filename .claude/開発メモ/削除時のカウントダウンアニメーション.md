# 削除時のカウントダウンアニメーション

## 課題一覧

### 1. ボード詳細でのカウントダウン未動作

ボード詳細画面で複数のメモやタスクを選択してゴミ箱アイコンをクリックした際に、カウントダウンアニメーションが動作しない問題が発生していた。

- **症状**: メモ一覧・タスク一覧では正常にカウントダウン（2→1→0など）が表示されるが、ボード詳細では表示されない
- **期待動作**: ボード詳細でもメモ一覧と同様にカウントダウンアニメーションが表示される

### 2. カウントダウンで0が表示されない

カウントダウンアニメーションで最後の「0」が画面に表示されない問題が発生していた。

- **症状**: 3→2→1→（0が表示されない）
- **期待動作**: 3→2→1→0（1秒表示）

## 調査過程

### 課題1: ボード詳細での未動作調査

#### 1. 初期調査

- `useBulkDeleteOperations`フックと`board-detail-screen.tsx`を確認
- `currentDisplayCount`の計算ロジックに問題を発見：`memoIdsAsNumbers.size`が常に0になっていた

#### 2. 第一次修正試行

- ID型変換の問題（OriginalId（string）→ number）を修正
- しかし、カウントダウンアニメーション自体は動作しなかった

#### 3. 詳細デバッグ

- `useBulkAnimation`、`useBulkDeleteOperations`、`bulkAnimationUtils`にデバッグログを追加
- アニメーションは初期化されるが、カウントダウンステップが実行されていないことが判明

#### 4. 根本原因の特定

- `useBulkAnimation`の`useEffect`でチェック状態（`checkedItems`）が変更されるたびに`clearTimers()`が呼ばれていた
- `startCountdown`でタイマーを設定した直後に、状態変更によってタイマーがクリアされていた

### 課題2: 0表示されない問題調査

#### 1. デバッグログ追加

- `startCountdown`にデバッグログを追加して動作確認
- ログでは0に到達しているが画面に表示されないことを確認

#### 2. UI表示条件の調査

- `delete-button.tsx`で`displayCount > 0`の条件により0が除外されていることを発見
- `finalizeAnimation`のタイミング競合も確認

#### 3. 根本原因の特定

- `delete-button.tsx`の表示条件で0が除外
- `finalizeAnimation`が早めに呼ばれて`setIsCountingActive(false)`でカウンターが無効化される競合

## 解決方法

### 課題1の修正: ボード詳細での未動作

```typescript
// use-bulk-animation.tsx
// 修正前
useEffect(() => {
  if (checkedItems.size > 0) {
    clearTimers();
  }
}, [checkedItems]);

// 修正後
useEffect(() => {
  if (checkedItems.size > 0 && !isCountingActive) {
    clearTimers();
  }
}, [checkedItems, isCountingActive]);
```

**キーポイント**: アニメーション実行中（`isCountingActive = true`）はタイマーをクリアしないように条件を追加

### 課題2の修正: 0表示されない問題

#### 2-1. UI表示条件の修正

```typescript
// delete-button.tsx
// 修正前
{displayCount !== undefined && displayCount > 0 && (

// 修正後
{displayCount !== undefined && displayCount >= 0 && (
```

#### 2-2. カウントダウンロジックの簡素化

```typescript
// use-bulk-animation.tsx startCountdown関数
// 修正前（複雑な分岐とtargetCount判定）
if (currentCount <= targetCount) {
  hasReachedTarget = true;
  setTimeout(() => {
    clearInterval(counterTimer);
  }, 1000);
  return; // ここでreturnするため0が表示されない
}

// 修正後（0まで確実にカウント）
const counterTimer = setInterval(() => {
  setDisplayCount(currentCount);

  if (currentCount <= 0) {
    clearInterval(counterTimer);
    setTimeout(() => setIsCountingActive(false), 1000);
    return;
  }

  currentCount--;
}, decrementInterval);
```

#### 2-3. タイマー競合の解決

```typescript
// use-bulk-animation.tsx finalizeAnimation
// 修正前
setIsCountingActive(false); // カウンター制御と競合

// 修正後
// カウンター制御はstartCountdown側に任せる（削除）
```

#### 2-4. アニメーション終了タイミングの調整

```typescript
// bulkAnimationUtils.ts
// 修正前
setTimeout(() => {
  finalizeAnimation(setIsProcessing, setIsLidOpen, isPartial);
}, 1500); // 長すぎて蓋が開きっぱなし

// 修正後
setTimeout(() => {
  finalizeAnimation(setIsProcessing, setIsLidOpen, isPartial);
}, 800); // 蓋を早めに閉じる
```

## 技術的詳細

### 関連ファイル

- `/apps/web/src/hooks/use-bulk-animation.tsx`
- `/apps/web/src/hooks/use-bulk-delete-operations.ts`
- `/apps/web/components/screens/board-detail-screen.tsx`

### 修正されたロジックフロー

1. ユーザーがゴミ箱アイコンをクリック
2. `initializeAnimation`でアニメーション開始（`isCountingActive = true`）
3. `startCountdown`でカウントダウンタイマー設定
4. チェック状態が変更されてもタイマーは保護される（`isCountingActive`条件により）
5. カウントダウンが正常に実行される（2→1→0）

### currentDisplayCount計算の改善

```typescript
// useBulkDeleteOperationsで追加
const currentMemoDisplayCount = bulkAnimation.isCountingActive
  ? bulkAnimation.displayCount
  : checkedMemos.size;

const currentTaskDisplayCount = bulkAnimation.isCountingActive
  ? bulkAnimation.displayCount
  : checkedTasks.size;
```

## 検証結果

### 課題1の解決確認

- ボード詳細でメモを複数選択→ゴミ箱クリック→正常にカウントダウンアニメーション表示
- タスクでも同様に動作確認
- メモ一覧・タスク一覧の既存動作に影響なし

### 課題2の解決確認

- カウントダウンが0まで正常に実行される（3→2→1→0）
- 0が1秒間しっかり表示される
- 蓋が適切なタイミング（800ms後）で閉じる

### 副次的な問題解決

- 「1の後に削除時のカウントが一瞬表示されてしまう問題」も同時に解決
- アニメーション終了タイミングの最適化により、UI全体の動作がスムーズになった

## 学んだ教訓

1. **タイマーの競合状態**: React の`useEffect`による状態変更とタイマー処理の競合に注意
2. **アニメーション保護**: 実行中のアニメーションは適切にガードする必要がある
3. **UI表示条件の重要性**: `> 0` vs `>= 0` の微細な違いが表示に大きく影響
4. **段階的デバッグ**: ログによる詳細な状態追跡が根本原因特定に有効
5. **タイミング調整の波及効果**: 一つのタイミング修正が複数の問題を解決することがある

## コード品質改善

- 修正完了後、すべてのデバッグログを削除予定
- lint警告も解決し、コードをクリーンアップ
- TypeScript型チェックも通過
- カウントダウンロジックが簡素化され、保守性が向上

修正日: 2025-01-27（初回）、2025-01-27（0表示問題対応）
