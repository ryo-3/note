# 404エラー問題の調査と解決

## 問題の概要
- **症状**: タスク削除時に404 Not Found エラーが発生
- **エラー内容**: `GET http://localhost:8794/boards/items/task/{id}/boards 404 (Not Found)`
- **発生パターン**: タスク削除時のみ。メモ削除では発生しない

## 調査過程

### 1. 初期の誤った仮説
- **仮説**: APIエンドポイントのパス問題やプリフェッチタイミング問題
- **対策**: URLパス修正、`removeQueries`追加、`setQueryData`使用
- **結果**: 問題解決せず、根本原因に至らず

### 2. ログ追加による詳細調査
削除時のログを追加して実際の実行順序を確認：
```
🗑️ Task 169 deleted
❌ 404: task 169 deleted but still prefetching
```

**スタックトレース分析結果:**
- `invalidateQueries` → `refetchQueries` の順で実行
- `invalidateQueries`は非同期処理
- その直後に`refetchQueries`が実行され、古いアイテム配列でプリフェッチ実行

### 3. 根本原因の特定
**メモとタスクの削除処理の違いを比較:**

```typescript
// メモ削除処理（use-memos.ts）
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ['memos'] })
  queryClient.invalidateQueries({ queryKey: ['deletedMemos'] })
  queryClient.invalidateQueries({ queryKey: ['boards'] })
  queryClient.invalidateQueries({ queryKey: ['board-with-items'] })
  queryClient.invalidateQueries({ queryKey: ['board-deleted-items'] })
  // item-boards の無効化なし ← ここが重要
}

// タスク削除処理（use-tasks.ts）
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ['tasks'] })
  queryClient.invalidateQueries({ queryKey: ['deleted-tasks'] })
  queryClient.invalidateQueries({ queryKey: ["boards"] })
  queryClient.invalidateQueries({ queryKey: ['board-with-items'] })
  queryClient.invalidateQueries({ queryKey: ['board-deleted-items'] })
  queryClient.invalidateQueries({ queryKey: ["item-boards"] }) // ← これが原因
}
```

## 根本原因

**タスク削除時のみ `item-boards` キャッシュを無効化していたため:**
1. タスク削除実行
2. `invalidateQueries({ queryKey: ["item-boards"] })` 実行
3. プリフェッチの `refetchQueries` が自動実行
4. まだ削除されたタスクが配列に残っている状態でAPIコール
5. 削除済みタスクで404エラー発生

**メモでは404が出なかった理由:**
- `item-boards` の無効化をしていなかった
- プリフェッチのリフェッチが発生しなかった

## 解決策

### 最終的な解決方法
タスク削除処理から `item-boards` の無効化を削除し、メモ削除と同じ処理に統一：

```typescript
// 修正後のタスク削除処理
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ['tasks'] })
  queryClient.invalidateQueries({ queryKey: ['deleted-tasks'] })
  queryClient.invalidateQueries({ queryKey: ["boards"] })
  queryClient.invalidateQueries({ queryKey: ['board-with-items'] })
  queryClient.invalidateQueries({ queryKey: ['board-deleted-items'] })
  // item-boards の無効化を削除
}
```

### 他の検討した解決策（採用せず）
1. **URLパス修正**: エンドポイントは正しく実装済みだった
2. **removeQueries追加**: タイミング問題が解決できなかった
3. **setQueryData使用**: 複雑になりすぎ、副作用のリスク

## 学んだこと

### React Queryの特性
1. **invalidateQueries の非同期性**: キャッシュ無効化は非同期で実行される
2. **refetchQueries の自動実行**: 無効化後に自動でリフェッチが発生
3. **プリフェッチとの相互作用**: プリフェッチ中のクエリも影響を受ける

### デバッグの重要性
1. **症状だけでの推測は危険**: 表面的な問題に惑わされやすい
2. **ログによる実行順序確認**: 実際の動作を確認することが重要
3. **類似処理との比較**: 動く処理と動かない処理の違いを比較

### 設計の一貫性
1. **統一された処理**: メモとタスクで削除処理を統一すべき
2. **不要な無効化の回避**: 必要以上のキャッシュ無効化は副作用を生む
3. **プリフェッチとの協調**: キャッシュ無効化とプリフェッチの相互作用を考慮

## 今後の注意点
- キャッシュ無効化は必要最小限に留める
- 異なるアイテムタイプで処理を統一する
- プリフェッチ機能追加時はキャッシュ無効化との相互作用を考慮

## 実装履歴
- **2025-01-27**: 404エラー発生、初期調査開始
- **2025-01-27**: ログ追加による詳細調査
- **2025-01-27**: メモとタスクの処理比較により根本原因特定
- **2025-01-27**: item-boards無効化削除により解決

## 関連ファイル
- `apps/web/src/hooks/use-tasks.ts`: タスク削除処理修正
- `apps/web/src/hooks/use-memos.ts`: メモ削除処理（参考）
- `apps/web/src/hooks/use-boards.ts`: プリフェッチ処理