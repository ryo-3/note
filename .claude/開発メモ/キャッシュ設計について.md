# 開発メモ

## React Query キャッシュ設計仕様書

### 概要
このアプリケーションではReact Queryを使用してAPI通信とキャッシュ管理を行っています。
複雑なデータ依存関係を持つため、キャッシュの無効化戦略が重要です。

### キャッシュキー構造

#### 1. 基本エンティティのキャッシュキー

| エンティティ | キー構造 | 用途 |
|------------|---------|-----|
| メモ | `['memos']` | メモ一覧 |
| 削除済みメモ | `['deletedMemos']` | 削除済みメモ一覧 |
| タスク | `['tasks']` | タスク一覧 |
| 削除済みタスク | `['deleted-tasks']` | 削除済みタスク一覧 |
| カテゴリー | `['categories']` | カテゴリー一覧 |
| タグ | `['tags', options]` | タグ一覧（オプション付き） |
| タグ付け | `['taggings', options]` | タグ付け情報 |
| **全タグ付け** | `['taggings', 'all']` | **全タグ付け情報（事前取得用）** |
| **全ボードアイテム** | `['boards', 'all-items']` | **全ボードアイテム（事前取得用）** |

#### 2. ボード関連のキャッシュキー

| キー構造 | 用途 | 備考 |
|---------|-----|------|
| `['boards', status]` | ボード一覧（ステータス別） | active/archived |
| `['boards', boardId, 'items']` | 特定ボードのアイテム一覧 | メモ・タスク混在 |
| `['boards', 'slug', slug]` | Slug検索用 | URL用 |
| `['board-deleted-items', boardId]` | ボード固有の削除済みアイテム | |

#### 3. 関連データのキャッシュキー

| キー構造 | 用途 | 重要な注意点 |
|---------|-----|------------|
| `['item-boards', itemType, itemId]` | アイテムが所属するボード一覧 | **itemIdは数値型** |
| `['taggings', { targetType, targetOriginalId }]` | 特定アイテムのタグ情報 | originalIdベース |
| `['category-usage', categoryId]` | カテゴリー使用状況 | |

### キャッシュ無効化パターン

#### 1. メモ操作時の無効化

```typescript
// メモ作成・更新
invalidateQueries(['memos'])

// メモ削除
invalidateQueries(['memos'])
invalidateQueries(['deletedMemos'])
refetchQueries(['boards'])  // ボード統計更新のため強制再取得

// メモ復元
invalidateQueries(['memos'])
invalidateQueries(['deletedMemos'])
refetchQueries(['boards'])
```

#### 2. タスク操作時の無効化

```typescript
// タスク作成・更新
invalidateQueries(['tasks'])
invalidateQueries(['boards'])      // ボード一覧
invalidateQueries(['item-boards']) // アイテムボード情報

// タスク削除
invalidateQueries(['tasks'])
invalidateQueries(['deleted-tasks'])
refetchQueries(['boards'])  // 強制再取得

// タスク復元
invalidateQueries(['tasks'])
invalidateQueries(['deleted-tasks'])
refetchQueries(['boards'])
```

#### 3. ボード操作時の無効化

```typescript
// ボード作成・更新・削除
invalidateQueries(['boards'])

// ボード更新時（追加）
invalidateQueries(['boards', boardId])

// アイテム追加時
invalidateQueries(['boards', boardId, 'items'])
invalidateQueries(['item-boards', itemType, parseInt(itemId)])  // 重要: 数値変換
invalidateQueries(['boards'])

// アイテム削除時
invalidateQueries(['boards', boardId, 'items'])
invalidateQueries(['item-boards', itemType, itemId])
invalidateQueries(['boards'])
```

#### 4. タグ・カテゴリー操作時の無効化

```typescript
// タグ削除
invalidateQueries(['tags'])
invalidateQueries(['taggings'])

// タグ付け操作
invalidateQueries(['taggings'])

// カテゴリー操作
invalidateQueries(['categories'])
```

### 重要な実装上の注意点

#### 1. ID型の不整合問題

**問題の背景:**
- APIからはitemIdが**文字列**として返される（例: "123"）
- キャッシュキーでは**数値**として扱う必要がある（例: 123）

**解決策:**
```typescript
// ボードアイテム追加時の修正例
onSuccess: (newItem, { boardId, data }) => {
  const itemId = newItem.itemId || data.itemId;
  const itemType = newItem.itemType || data.itemType;
  
  // 重要: string → number変換
  queryClient.invalidateQueries({ 
    queryKey: ["item-boards", itemType, parseInt(itemId)] 
  });
}
```

#### 2. originalId vs id の使い分け

**設計思想:**
- `id`: データベースの主キー（AUTO_INCREMENT）
- `originalId`: 削除・復元追跡用の文字列ID（`id.toString()`）

**使用場面:**
- ボード管理: `originalId`を使用
- タグ管理: `originalId`を使用
- キャッシュキー: 数値の`id`を使用（互換性のため）

#### 3. キャッシュ更新の最適化

**invalidateQueries vs refetchQueries:**
- `invalidateQueries`: キャッシュを無効化（次回アクセス時に再取得）
- `refetchQueries`: 即座に再取得（統計情報更新時など）

**使い分けの指針:**
- 通常の更新: `invalidateQueries`
- 削除・復元時のボード統計: `refetchQueries`（即座に反映が必要）

### トラブルシューティング

#### キャッシュが更新されない場合のチェックポイント

1. **キーの型を確認**
   - itemIdが文字列/数値で一致しているか
   - 特に`item-boards`キーは数値型必須

2. **キーの階層を確認**
   - 正しい順序でキーが指定されているか
   - 例: `['boards', boardId, 'items']` の順序

3. **無効化の範囲を確認**
   - 部分一致で無効化する場合: `['item-boards']`
   - 完全一致で無効化する場合: `['item-boards', 'memo', 123]`

4. **タイミングの確認**
   - onSuccessで無効化しているか
   - 必要に応じてrefetchQueriesを使用しているか

### 全データ事前取得システム（2025-08-09追加）

#### 概要
N+1問題とUIのちらつきを解消するため、画面初期化時に全関連データを事前取得する方式を実装。

#### 新規フック

```typescript
// apps/web/src/hooks/use-all-data.ts

// 全タグ付け情報を取得
useAllTaggings() 
// キー: ['taggings', 'all']
// 用途: 全画面でタグ情報を事前取得

// 全ボードアイテム情報を取得  
useAllBoardItems()
// キー: ['boards', 'all-items'] 
// 用途: 全画面でボード紐付け情報を事前取得
```

#### キャッシュ設定

```typescript
{
  staleTime: 5 * 60 * 1000,     // 5分間は新鮮なデータとして扱う
  gcTime: 30 * 60 * 1000,        // 30分間キャッシュを保持
  refetchOnWindowFocus: false,   // ウィンドウフォーカス時の再取得を無効化
  refetchOnMount: false,          // マウント時の再取得を無効化
  retry: 3,                       // 最大3回リトライ
}
```

#### 無効化パターンの追加

```typescript
// タグ付け操作時
invalidateQueries(['taggings'])      // 個別タグ付け
invalidateQueries(['taggings', 'all']) // 全タグ付け（事前取得用）

// ボードアイテム操作時  
invalidateQueries(['boards', boardId, 'items'])  // 特定ボード
invalidateQueries(['boards', 'all-items'])       // 全ボードアイテム（事前取得用）
```

#### パフォーマンス改善効果

- **APIコール削減**: 各アイテム個別取得（40回） → 事前一括取得（2-4回）
- **初回表示**: 400-2000ms → 100-200ms
- **エディター切替**: ちらつきあり → 即座に表示（ちらつきなし）

### 今後の改善ポイント

1. **型安全性の向上**
   - キャッシュキーの型定義を統一
   - IDの型変換を自動化

2. **パフォーマンス最適化**
   - 不要な無効化を削減
   - 部分的な更新の実装

3. **デバッグツールの活用**
   - React Query DevToolsでキャッシュ状態を監視
   - キー構造の可視化

---

最終更新: 2025-08-09