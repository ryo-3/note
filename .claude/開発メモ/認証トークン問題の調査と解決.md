# 認証トークン問題の調査と解決

## 問題の概要

- **症状**: 間欠的に401 Unauthorized エラーが発生
- **対象エンドポイント**:
  - `/boards?status=normal`
  - `/boards/{id}/items`
  - `/boards/{id}/deleted-items`
  - `/boards/items/{type}/{id}/boards`
- **発生パターン**: 時間経過後、複数操作時に発生しやすい

## 調査過程

### 1. 初期仮説：キャッシュ時間の問題

- **仮説**: トークンキャッシュ時間（30分）が長すぎる
- **対策**: キャッシュ時間を30分 → 10分 → 5分に短縮
- **結果**: 効果限定的、根本解決に至らず

### 2. トークン取得パターンの調査

コンソールログを追加してトークン変化を監視：

```javascript
console.log(
  `🔑 Token: ${tokenStart}, Changed: ${hasChanged}, Time: ${new Date().toLocaleTimeString()}`,
);
```

**発見された実際のパターン：**

```
7:00:53 - 最初のトークン (Changed: true)
7:01:04 - 新しいトークン (Changed: true) ← 約11秒後
7:01:52 - 新しいトークン (Changed: true) ← 約48秒後
```

### 3. 根本原因の特定

**Clerkの実際の動作：**

- トークンは予想以上に頻繁に更新される（11秒〜48秒間隔）
- 同時に複数のAPIリクエストが発生する
- トークン更新の瞬間に競合状態が発生

**問題の構造：**

```
時刻 7:01:52 - Clerkがトークンを更新
├── リクエスト1: getToken() → 新トークンB取得 ✅
├── リクエスト2: getToken() → 新トークンB取得 ✅
└── リクエスト3: (遅延) → 古トークンA使用 ❌ 401エラー
```

## 解決策

### 最終的な解決方法：トークン取得の同期化

```javascript
let tokenPromise: Promise<string | null> | null = null;

async function getCachedToken(getToken: () => Promise<string | null>): Promise<string | null> {
  // 既に取得中の場合は同じPromiseを返す（同期化）
  if (tokenPromise) {
    return tokenPromise;
  }

  // 新しいトークン取得を開始
  tokenPromise = (async () => {
    const token = await getToken();
    // 取得完了後、Promiseをクリア
    tokenPromise = null;
    return token;
  })();

  return tokenPromise;
}
```

**効果：**

- 複数の同時リクエストが同じPromiseを待機
- 全てのリクエストが同じ最新トークンを使用
- 競合状態を根本的に解決

### 実装済みのリトライ機能

各API関数で401エラー時の自動リトライを実装：

```javascript
// 401エラーの場合はキャッシュをクリアしてリトライ
if (response.status === 401 && attempt === 0) {
  cachedToken = null;
  tokenExpiry = 0;
  continue;
}
```

**対象関数：**

- `useBoards`
- `useBoardWithItems`
- `useBoardDeletedItems`
- `useItemBoards`
- `usePrefetchItemBoards`

## 学んだこと

### Clerkの認証トークンの特性

1. **更新頻度**: 開発環境では非常に頻繁（数十秒間隔）
2. **ライフサイクル**: 内部的な更新ロジックあり
3. **同時性**: 複数リクエストでの同期が重要

### 対策の優先順位

1. **同期化** > キャッシュ時間調整
2. **リトライ機能** > エラーハンドリング
3. **ログ監視** > 問題の早期発見

### 今後の注意点

- 本番環境でのトークン更新パターンは異なる可能性
- ログ出力は開発時のみに限定
- パフォーマンスへの影響を継続監視

## 実装履歴

- **2025-01-26**: 初期調査開始、キャッシュ時間短縮
- **2025-01-26**: トークンログ追加、問題パターン特定
- **2025-01-26**: 同期化実装、根本解決

## 関連ファイル

- `apps/web/src/hooks/use-boards.ts`: メイン実装
- `apps/api/src/routes/boards/route.ts`: Clerk設定
- `apps/api/src/routes/boards/api.ts`: API認証処理
