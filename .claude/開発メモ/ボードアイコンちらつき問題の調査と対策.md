# ボードアイコンちらつき問題の調査と対策 ✅ **完全解決済み**

## 問題の概要

### 現象
- **メモ一覧**でボード紐付きメモAからボード紐付きメモBに移動する時
- **右側エディターの**ボードアイコンが一瞬グレー（bg-gray-100）になってから青（bg-light-Blue）に戻る
- **タスク一覧・ボード詳細**でも同様のちらつきが発生
- **ボード名フィルター**適用時にもアイテムが一瞬消える

### 発生条件
- ボード紐付きアイテム → ボード紐付きアイテム の移動時
- コントロールパネルでボード名表示がOFFの時により顕著
- ボード詳細内でのタスク切り替え時

## 根本原因の分析

### データ構造の問題
1. **メモ/タスク本体のデータ** (memos/tasksテーブル) - React Query キャッシュ
2. **ボード紐付け情報** (board_itemsテーブル) - 別クエリ、別キャッシュ

### アイテム切り替え時の処理フロー
1. メモ/タスクのデータは一覧キャッシュから即座に切り替わる
2. `useItemBoards('memo', memo?.id)`で新しいアイテムのボード情報を取得開始
3. **queryKey変更により前のボード情報がクリアされる**
4. 新しいボード情報が取得完了するまでボードアイコンがグレーになる

### 特定された具体的原因
- **placeholderData未適用**: 新しいqueryKeyの初回リクエスト時にはplaceholderDataが効かない
- **状態初期化の問題**: エディターでselectedBoardIdsが空配列で初期化される
- **プリフェッチ不足**: ボード詳細画面ではプリフェッチが実装されていない

## 実装した完全対策

### 1. プリフェッチ機能の追加
```typescript
// usePrefetchItemBoardsフック
export function usePrefetchItemBoards(itemType: 'memo' | 'task', items: { id: number }[] | undefined) {
  return useQueries({
    queries: (items || []).map(item => ({
      queryKey: ["item-boards", itemType, item.id],
      queryFn: async () => { /* ボード情報取得 */ },
      enabled: !!items && items.length > 0,
      staleTime: 5 * 60 * 1000,  // 5分間キャッシュ
      refetchOnMount: false,     // マウント時の再取得を無効化
      refetchOnWindowFocus: false, // ウィンドウフォーカス時の再取得を無効化
    }))
  });
}
```

### 2. 全画面でのプリフェッチ実装
```typescript
// memo-screen.tsx
usePrefetchItemBoards('memo', memos);

// task-screen.tsx  
usePrefetchItemBoards('task', tasks);

// board-detail-screen.tsx
usePrefetchItemBoards('memo', memoItemsForPrefetch);
usePrefetchItemBoards('task', taskItemsForPrefetch);
```

### 3. placeholderData追加
```typescript
export function useItemBoards(itemType: 'memo' | 'task', itemId: number | undefined) {
  return useQuery<Board[]>({
    queryKey: ["item-boards", itemType, itemId],
    queryFn: async () => { /* API呼び出し */ },
    enabled: !!itemId,
    placeholderData: keepPreviousData, // 前のデータを保持してちらつき防止
  });
}
```

### 4. エディター状態初期化の改善
```typescript
// メモエディター: useSimpleMemoSave
const [selectedBoardIds, setSelectedBoardIds] = useState<number[]>(currentBoardIds) // 空配列ではなく初期値設定

// タスクエディター: useBoardChangeModal
export function useBoardChangeModal(initialBoardIds: string[] = []) {
  const [selectedBoardIds, setSelectedBoardIds] = useState<string[]>(initialBoardIds); // 初期値対応
}
```

### 5. フィルター条件の最適化
```typescript
// memo-filter-wrapper.tsx, task-filter-wrapper.tsx
// ローディング中かつデータがない場合のみ非表示（プリフェッチキャッシュがある場合は表示）
if (isLoading && !boards) {
  return null;
}
```

### 6. アニメーション削除
```typescript
// board-icon-selector.tsx
// transition-colorsを削除して即座に色変更
className={`flex items-center justify-center size-7 rounded-md ${...}`}
```

## 完全解決の確認

### 解決前のログパターン
```
ItemBoards:0 | Loading:true | SelectedBoardIds:0   ← グレーアイコン（ちらつき）
ItemBoards:1 | Loading:false | SelectedBoardIds:0  ← まだグレー
ItemBoards:1 | Loading:false | SelectedBoardIds:1  ← やっと青アイコン
```

### 解決後のログパターン
```
ItemBoards:1 | Loading:false | SelectedBoardIds:1  ← 最初から青アイコン（ちらつきなし）
```

### プリフェッチ統計例
```
[Prefetch] Memos:289 | Loaded:289 | Boards:154
[Task Prefetch] Tasks:156 | Loaded:156 | Boards:89
[Board Detail Prefetch] Memos:148/148 | Tasks:48/48
```

## 解決された全ての箇所 ✅

1. **メモ一覧画面**: エディターでのボードアイコンちらつき解消
2. **タスク一覧画面**: エディターでのボードアイコンちらつき解消
3. **ボード詳細画面**: メモ・タスク切り替え時のちらつき解消
4. **ボード名フィルター**: フィルター適用時のアイテム表示ちらつき解消
5. **ボード名表示切り替え**: ON/OFF切り替え時の再リクエスト防止

## 最終的な技術スタック

### 使用技術
- **React Query**: キャッシュ管理とプリフェッチ
- **useQueries**: 複数アイテムの並列プリフェッチ
- **placeholderData**: 前データ保持によるちらつき防止
- **keepPreviousData**: アイテム切り替え時の滑らかな遷移

### パフォーマンス最適化
- **積極的プリフェッチ**: 画面読み込み時に全アイテムのボード情報を事前取得
- **キャッシュ活用**: 5分間のstaleTime設定
- **不要な再取得防止**: refetchOnMount/refetchOnWindowFocus無効化

## 参考：React Queryのキャッシュキー
- メモ一覧: `['memos']`
- タスク一覧: `['tasks']`  
- ボード情報: `["item-boards", itemType, itemId]`
- ボード一覧: `["boards"]`

## コミット履歴
- 初期プリフェッチ実装: コミット 2731340
- 完全修正: コミット 75f1b79 「ボードアイコンのちらつき問題を完全修正」

**状況**: ✅ **完全解決済み** - 全画面でボードアイコンがスムーズに動作