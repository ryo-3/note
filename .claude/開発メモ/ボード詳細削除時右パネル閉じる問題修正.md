# ボード詳細削除時右パネル閉じる問題修正

## 問題概要

ボード詳細でメモ・タスクを削除した際に右パネルが閉じてしまい、メモ一覧のように次のアイテムが選択されない問題があった。

## 症状

- **メモ一覧**: 削除時に右パネルが開いたまま次のメモが選択される（正常）
- **ボード詳細**: 削除時に右パネルが閉じてしまう（問題）

## 調査で発見した根本原因

### 1. データ構造の違い

- **メモ一覧**: `Memo[]` の配列を直接扱う
- **ボード詳細**: `BoardItemWithContent[]` → フィルタしてMemoを抽出

### 2. 次選択のロジックの問題

- **メモ一覧**: 削除前の`allMemos`配列から直接次のメモを見つける
- **ボード詳細**: `memoItems`（BoardItemWithContent）から探すが、**削除時に空になっている**

### 3. 選択状態管理の違い

- **メモ一覧**: 同一コンポーネント内でuseStateで完結
- **ボード詳細**: props経由で親（board-detail-client.tsx）に状態を持たせている

### 4. キャッシュ無効化のタイミング

- **メモ一覧**: 削除後すぐに自動でデータが更新される
- **ボード詳細**: 手動で500ms後にキャッシュ無効化していた

## 躓いたポイント

### 1. onSelectMemoコールバックが実行されない問題

```
ログから判明:
- 🔥 onSelectMemo呼び出し: 992 onSelectMemo function: function ← 実行されている
- しかし 🟢 メモ選択: 992 ログが表示されない ← board-detail-client.tsxに届いていない
```

**原因**: 簡易メモオブジェクトを作成していたが、propsチェーンのどこかで途切れていた

### 2. 削除時にmemoItemsが空になる問題

```
ログで確認:
- 🔥 全アイテム数: 0
- 🔥 メモアイテム数: 0
```

**原因**: React Queryのキャッシュ無効化タイミングと削除処理のタイミングが競合

### 3. 複雑なボード構造での次選択の困難さ

**問題**: DOM順序は通常のメモIDを取得するが、ボード詳細では`BoardItemWithContent`構造を使用しているため、照合が困難

## 解決策

### 1. 削除前データの活用

```typescript
// 修正前：削除後の空のmemoItemsを使用
const allItems = [...memoItems, ...taskItems]; // 空配列

// 修正後：削除前のboardMemosを使用
const allMemos = boardMemos; // 削除前のデータを活用
```

### 2. メモ一覧と同じロジックの採用

```typescript
// 既存の実績あるロジックを使用
const nextMemo = getNextItemAfterDeletion(allMemos, deletedMemo, displayOrder);
```

### 3. 統一されたキャッシュ管理

```typescript
// useDeleteMemoのonSuccessにボード関連キャッシュも追加
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ["memos"] });
  queryClient.invalidateQueries({ queryKey: ["deletedMemos"] });
  // ボード関連のキャッシュも無効化（復元処理と同様）
  queryClient.invalidateQueries({ queryKey: ["boards"] });
  queryClient.invalidateQueries({ queryKey: ["board-with-items"] });
  queryClient.invalidateQueries({ queryKey: ["board-deleted-items"] });
};
```

### 4. 手動キャッシュ無効化の削除

- setTimeout による500ms遅延の手動キャッシュ無効化を削除
- React Queryの自動キャッシュ無効化に統一

## 修正したファイル

### コア修正

1. **use-board-operations.ts**: 削除後次選択ロジックを削除前データ使用に変更
2. **board-right-panel.tsx**: 手動キャッシュ無効化を削除
3. **board-detail-client.tsx**: 選択状態管理の復元ロジック改善

### キャッシュ管理統一

4. **use-memos.ts**: useDeleteMemoにボード関連キャッシュ無効化を追加
5. **use-tasks.ts**: useDeleteTaskにボード関連キャッシュ無効化を追加

## 学んだこと

### 1. データ構造の統一の重要性

複雑なデータ構造（BoardItemWithContent）を使う場合でも、操作ロジックでは基本構造（Memo/Task）に戻すことで、既存ロジックを再利用できる。

### 2. 削除処理での「削除前データ」の重要性

削除操作中は「削除前の状態」を保持して次選択ロジックで使用する必要がある。削除後のデータは既に変更されているため信頼できない。

### 3. React Queryキャッシュ戦略の統一

- 手動キャッシュ無効化は複雑になりがち
- mutation の onSuccess での自動無効化を統一して使う方が保守性が高い

### 4. ログ駆動デバッグの有効性

複雑な状態管理では、各ステップでのログ出力により問題箇所を特定できる。特に：

- 関数が呼ばれているか
- データが期待通りか
- コールバックが実行されているか

### 5. 既存ロジックの再利用価値

車輪の再発明せず、既に動作実績のあるロジック（getNextItemAfterDeletion）を活用することで、信頼性とメンテナンス性を両立できる。

## 最終結果

- ボード詳細でのメモ・タスク削除時に右パネルが閉じない
- 次のアイテムが正しく選択される
- メモ一覧と完全に統一された動作を実現
- コードが簡潔になり保守性が向上
