# 削除ボタン表示タイミング統一修正

## 問題

メモ・タスクの削除済みタブからの完全削除時に、ゴミ箱アイコンが即座に消えるのに対し、通常削除では3秒間表示され続ける不整合があった。

### 症状
- **通常削除**: 削除完了後3秒間ゴミ箱アイコンが表示される
- **完全削除**: 削除完了と同時に即座にゴミ箱アイコンが消える

## 原因

削除ボタンの表示制御で**ダブル管理**が発生していた：

1. `useBulkDeleteButton`フック: 3秒タイマー付きの`showDeleteButton`を作成
2. `getDeleteButtonVisibility`関数: 独自ロジックで表示制御

### 具体的な問題箇所

#### memo-screen.tsx / task-screen.tsx
```tsx
// useBulkDeleteButtonで3秒タイマー付きshowDeleteButtonを作成
const { showDeleteButton } = useBulkDeleteButton({
  // ...
});

// しかしBulkActionButtonsでは別の値を使用（3秒タイマーなし）
<BulkActionButtons
  showDeleteButton={getDeleteButtonVisibility({
    // この関数の結果は3秒タイマーを考慮しない
    // activeTab === "deleted"の場合は無視される
    showDeleteButton, // ← useBulkDeleteButtonの値を渡しているが無意味
  })}
/>
```

#### getDeleteButtonVisibility（bulkButtonUtils.ts）
```tsx
// 通常削除の場合
return showDeleteButton && !isRestoreModalOpen; // ← useBulkDeleteButtonの3秒タイマー付き値を使用

// 完全削除の場合（25〜36行目）
return // ← 独自ロジックでuseBulkDeleteButtonの値を無視
```

## 修正内容

### 1. 画面コンポーネントの修正

**修正前:**
```tsx
<BulkActionButtons
  showDeleteButton={getDeleteButtonVisibility({
    activeTab,
    deletedTabName: "deleted",
    checkedItems: checkedMemos,
    checkedDeletedItems: checkedDeletedMemos,
    isRestoreModalOpen,
    isRestoreLidOpen,
    isRestoring,
    showDeleteButton,
  })}
```

**修正後:**
```tsx
<BulkActionButtons
  showDeleteButton={showDeleteButton}
```

### 2. 不要なimportの削除

```tsx
// 削除
import { getDeleteButtonVisibility } from "@/src/utils/bulkButtonUtils";

// 削除
const { isRestoreModalOpen } = useTasksBulkRestore({
```

### 3. タイマー時間の調整

```tsx
// use-bulk-delete-button.ts
const showDeleteButton = useDelayedButtonVisibility(
  shouldShowLeftBulkDelete,
  isDeleting,
  1000  // 3秒 → 1秒に短縮
);
```

### 4. originalId使用エラーの修正

完全削除時に404エラーが発生していた問題も併せて修正：

**修正前:**
```tsx
const onApiCall = async (id: number) => {
  if (activeTab === "deleted") {
    await permanentDeleteNoteMutation.mutateAsync(String(id)); // ← 数値IDを使用
  }
};
```

**修正後:**
```tsx
const onApiCall = async (id: number) => {
  if (activeTab === "deleted") {
    // 削除済みメモの場合はoriginalIdを使用
    const deletedMemo = deletedMemos?.find(memo => memo.id === id);
    if (deletedMemo) {
      await permanentDeleteNoteMutation.mutateAsync(deletedMemo.originalId);
    } else {
      console.warn(`削除対象のメモが見つかりません: ID ${id}`);
    }
  }
};
```

## 修正ファイル一覧

### メモ側
- `apps/web/components/screens/memo-screen.tsx`
- `apps/web/components/features/memo/use-memo-bulk-delete.tsx`

### タスク側
- `apps/web/components/screens/task-screen.tsx`
- `apps/web/components/features/task/use-task-bulk-delete.tsx`

### 共通
- `apps/web/src/hooks/use-bulk-delete-button.ts`

### デバッグ用（削除可能）
- `apps/web/components/ui/layout/bulk-action-buttons.tsx` (デバッグログ追加)
- `apps/web/components/ui/layout/button-container.tsx` (デバッグログ追加)
- `apps/web/src/hooks/use-delayed-button-visibility.ts` (デバッグログ追加)
- `apps/web/src/hooks/use-bulk-animation.tsx` (デバッグログ追加)
- `apps/web/src/hooks/use-trash-icon-visibility.ts` (新規作成、DOM監視)

## 結果

✅ 通常削除・完全削除ともに削除完了後1秒でゴミ箱アイコンが消える統一動作
✅ 完全削除時の404エラーも解決
✅ メモ・タスク両方で同じ動作に統一

## 学んだこと

- 複数箇所で同じ状態を管理する際は、単一責任の原則を適用する
- フックの戻り値を別の関数で再加工する場合、元のロジックが無効化される可能性がある
- デバッグログは問題の特定に非常に有効だが、本番では削除すること
- `originalId`と数値`id`の使い分けに注意が必要