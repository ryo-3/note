# タグ表示機能とプリフェッチ仕組み ✅ **実装完了**

## 概要
メモ一覧でのタグ表示機能を実装。ボード名表示と同じ仕組みでプリフェッチとキャッシュを活用し、パフォーマンスを最適化。

## データ取得の流れ

### 1. メイン画面（MemoScreen）
```typescript
// 1. メモデータを取得
const { data: memos } = useMemos();

// 2. プリフェッチャーでボードとタグを事前取得（ちらつき防止）
<ItemBoardsPrefetcher type="memo" items={memos} />
<ItemTagsPrefetcher type="memo" items={memos} />
```

### 2. プリフェッチ実装（ItemTagsPrefetcher）
```typescript
// apps/web/components/shared/item-tags-prefetcher.tsx
export default function ItemTagsPrefetcher({ 
  type, 
  items 
}: { 
  type: 'memo' | 'task' | 'board'; 
  items: Array<{ id: number; originalId?: string }> | undefined;
}) {
  // usePrefetchItemTags で全アイテムのタグ情報を並列プリフェッチ
  usePrefetchItemTags(type, items);
  return null; // UIは持たない
}
```

### 3. プリフェッチフック（usePrefetchItemTags）
```typescript
// apps/web/src/hooks/use-taggings.ts
export function usePrefetchItemTags(
  itemType: 'memo' | 'task' | 'board', 
  items: { id: number; originalId?: string }[] | undefined
) {
  return useQueries({
    queries: (items || []).map(item => {
      const targetOriginalId = item.originalId || item.id.toString()
      return {
        queryKey: ['taggings', { targetType: itemType, targetOriginalId }],
        queryFn: async () => {
          const token = await getToken()
          const response = await taggingsApi.getTaggings(token, itemType, targetOriginalId)
          return response.json() as Tagging[]
        },
        enabled: isLoaded && !!items,
        staleTime: 2 * 60 * 1000,     // 2分間は新鮮なデータとして扱う
        gcTime: 10 * 60 * 1000,       // 10分間キャッシュを保持
        refetchOnWindowFocus: false,  // ウィンドウフォーカス時の再取得を無効化
        refetchOnMount: false,        // マウント時の再取得を無効化
      }
    })
  })
}
```

### 4. 個別アイテムでのタグ取得（MemoListItem）
```typescript
// メモエディターと同じoriginalId取得ロジックを使用
const targetOriginalId = !isDeleted && memo.id > 0 
  ? ((memo as Memo).originalId || memo.id.toString())
  : '';

// キャッシュからタグデータを高速取得
const { tags } = useItemTags('memo', targetOriginalId);
```

### 5. タグ表示ロジック
```typescript
// ボード名の右側にタグを表示
{/* ボード名・タグ表示 */}
{((showBoardName && boards && boards.length > 0) || (showTags && !isDeleted)) && (
  <div className="mb-1 flex items-center gap-2">
    {/* ボード名 */}
    {showBoardName && boards && boards.length > 0 && (
      <div className="flex flex-wrap gap-1">
        {boards.map(board => <BoardBadge />)}
      </div>
    )}
    
    {/* タグ表示 */}
    {showTags && !isDeleted && (
      <div className="flex flex-wrap gap-1">
        {tags && tags.length > 0 ? (
          tags.map(tag => <TagBadge />)
        ) : (
          <span className="text-xs text-gray-400">タグなし</span>
        )}
      </div>
    )}
  </div>
)}
```

## UI実装

### 1. コントロールパネルのタグ表示トグル
```typescript
// apps/web/components/ui/buttons/tag-display-toggle.tsx
<TagDisplayToggle
  showTags={showTagDisplay}
  onToggle={setShowTagDisplay}
  buttonSize="size-7"
  iconSize="size-4"
/>
```

### 2. タグバッジのスタイル
```typescript
// TAG_COLORS 定数を使用した統一スタイル
<span
  className="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium"
  style={{
    backgroundColor: TAG_COLORS.background, // #e8dcc0 ベージュ
    color: TAG_COLORS.text                  // #4a3018 茶色
  }}
>
  {tag.name}
</span>
```

### 3. 表示制御
- **コントロールパネル**: メモモードでのみタグ表示トグル表示
- **一覧表示**: リストビュー + タグ表示ON + 削除済みメモでない場合のみ表示
- **位置**: ボード名バッジの右側に横並び表示

## パフォーマンス最適化

### キャッシュ戦略
- **staleTime**: 2分間（ボードより短め、タグは変更頻度が高いため）
- **gcTime**: 10分間（メモリ効率とUX のバランス）
- **プリフェッチ**: 画面読み込み時に全メモのタグ情報を事前取得

### N+1問題の解決
- ✅ 各MemoListItemが個別にAPIリクエストを送ることを防止
- ✅ ItemTagsPrefetcher で一括プリフェッチしてキャッシュに保存
- ✅ useItemTags でキャッシュから高速取得

### originalId の統一
問題があった部分：
```typescript
// ❌ 間違い: memo-list-item で itemId.toString() を使用
const { tags } = useItemTags('memo', itemId.toString());

// ✅ 正解: memo-editor と同じロジックを使用  
const targetOriginalId = memo.originalId || memo.id.toString()
const { tags } = useItemTags('memo', targetOriginalId);
```

## 技術スタック

### データ取得
- **React Query**: キャッシュ管理とプリフェッチ
- **useQueries**: 複数メモのタグ情報並列プリフェッチ  
- **useItemTags**: 個別アイテムのタグ取得フック

### UI コンポーネント
- **TagDisplayToggle**: コントロールパネルの表示切り替えボタン
- **ItemTagsPrefetcher**: プリフェッチ専用コンポーネント（UIなし）
- **TAG_COLORS**: タグの統一カラーパレット

### API エンドポイント
- **GET /taggings**: クエリパラメータでフィルタリング
  - `targetType=memo&targetOriginalId=123`

## React Query キャッシュキー体系

```typescript
// タグ一覧
['tags', options] // { search?, sort?, limit? }

// タグ付け情報  
['taggings', { targetType: 'memo', targetOriginalId: '123' }]

// 特定アイテムのタグ（useItemTags）
['taggings', { targetType: 'memo', targetOriginalId: '123' }] // 同じキー
```

## 表示パターン例

```
[Board1]                          // ボードのみ
[tag1] [tag2]                     // タグのみ  
[Board1] [tag1] [tag2]            // 両方
[Board1] タグなし                   // ボードあり、タグなし
タグなし                           // 両方なし（タグ表示ON時）
```

## 実装完了項目 ✅

1. **データ取得基盤**: プリフェッチ + キャッシュ仕組み
2. **UI実装**: コントロールパネル + 一覧表示  
3. **デザイン統一**: TAG_COLORS による色の統一
4. **パフォーマンス**: N+1問題解決、キャッシュ最適化
5. **originalId統一**: メモエディターと同じロジック採用

## 今後の拡張ポイント

- タスク一覧でも同じ仕組みを適用可能
- ボード詳細でもタグ表示可能
- タグクリックでフィルタリング機能追加可能

**状況**: ✅ **実装完了** - メモ一覧でタグ表示が完全に動作