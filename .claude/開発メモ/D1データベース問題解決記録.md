# 開発メモ - D1データベース問題解決記録

## 2025-09-04: ローカルD1データベース完全復旧

### 🚨 発生した問題

- **症状**: API起動時に500 Internal Server Error
- **エラー内容**: `no such table: users/memos/tasks`
- **影響範囲**: 全てのAPIエンドポイントが機能停止

### 🔍 根本原因分析

1. **D1データベース状態管理問題**
   - `.wrangler/state`にキャッシュされた古い/不正なデータベース状態
   - 最新のスキーマ定義とデータベース実体の不一致

2. **マイグレーション履歴の混乱**
   - 複数のマイグレーションファイル（0000〜0010）が存在
   - どのマイグレーションが実際に適用されているか不明確
   - `users`テーブルの`display_name`フィールドがマイグレーションに反映されていない

3. **直接的なトリガー**
   - APIサーバー起動時にテーブルが存在しない、またはアクセス不可能な状態

### ✅ 解決手順

1. **完全リセット**: `rm -rf .wrangler` でローカルDB状態をクリア
2. **API停止**: `lsof -ti:7594 | xargs -r kill -9`
3. **スキーマ再生成**: `npm run db:generate` で最新スキーマをマイグレーションファイルに反映
4. **マイグレーション適用**: `npm run db:migrate:local` で最新ファイルをローカルDBに適用
5. **API再起動**: `npm run dev` (バックグラウンド実行)

### 📝 追加改善

- **ログ出力設定**: web.log, api.logファイルへの出力を追加
- **リセットコマンド**: `npm run db:reset` でワンコマンドリセット
- **バックグラウンド実行**: `run_in_background: true` でツール効率化

### 🔴 本番環境での潜在的問題

**⚠️ 重要**: 本番環境でも同様の問題が発生する可能性が高い

#### 予想される問題

- 本番D1データベースにテーブルが正しく生成されていない
- マイグレーション履歴と実際のテーブル構造が不一致
- `users`テーブルの`display_name`フィールドが欠落している可能性

#### 本番対応が必要な項目

1. **本番データベース状態確認**

   ```bash
   wrangler d1 execute petaboo --remote --command="SELECT name FROM sqlite_master WHERE type='table';"
   ```

2. **本番マイグレーション適用**

   ```bash
   npm run db:migrate:prod  # drizzle-kit push
   ```

3. **usersテーブル構造確認**
   ```bash
   wrangler d1 execute petaboo --remote --command="PRAGMA table_info(users);"
   ```

### 📋 今後の予防策

- **定期的なスキーマ同期**: ローカル・本番環境の定期確認
- **マイグレーション管理**: 世代管理と適用履歴の明確化
- **デプロイ前チェック**: 本番DBスキーマ確認の自動化

### 🎯 次のアクション

1. 本番環境のデータベース状態確認
2. 必要に応じて本番マイグレーション実行
3. デプロイプロセスの改善検討
