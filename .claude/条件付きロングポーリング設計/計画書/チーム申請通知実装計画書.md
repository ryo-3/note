# チーム申請通知実装計画書

## 🎯 実装目標

`http://localhost:7593/team/moricrew` ページで**管理者のみ**がリアルタイムでチーム申請通知を受け取る機能を実装

## 📋 実装仕様

### 1. 条件付きロング・ポーリングの適用

**発動条件**:

- ユーザーがチーム詳細ページを開いている
- ユーザーがそのチームの管理者である
- ブラウザタブがアクティブ状態

**ポーリング間隔**: 2分待機 + 即座レスポンス（新規申請があった場合）

## 🔧 技術実装

### Phase 1: サーバーサイド実装

#### 1.1 新APIエンドポイント

```typescript
// apps/api/src/routes/teams/wait-updates.ts
POST / teams / { customUrl } / wait - updates;
```

**リクエスト**:

```json
{
  "lastCheckedAt": "2024-09-11T02:30:00.000Z",
  "waitTimeoutSec": 120
}
```

**レスポンス（新規申請有り）**:

```json
{
  "hasUpdates": true,
  "updates": {
    "newApplications": [
      {
        "id": 123,
        "userId": "user_abc123",
        "displayName": "山田太郎",
        "appliedAt": "2024-09-11T02:31:15.000Z"
      }
    ]
  },
  "timestamp": "2024-09-11T02:31:15.000Z"
}
```

**レスポンス（タイムアウト）**:

```json
{
  "hasUpdates": false,
  "timestamp": "2024-09-11T02:32:00.000Z"
}
```

#### 1.2 権限チェック

- JWT解析でユーザー認証
- チーム管理者権限確認
- 不正アクセス時は403エラー

#### 1.3 効率的クエリ設計

```sql
-- 新規申請チェック（lastCheckedAt以降）
SELECT ua.id, ua.userId, ua.appliedAt, u.displayName
FROM user_applications ua
JOIN users u ON ua.userId = u.id
WHERE ua.teamId = ?
  AND ua.status = 'pending'
  AND ua.appliedAt > ?
ORDER BY ua.appliedAt DESC;
```

### Phase 2: クライアントサイド実装

#### 2.1 汎用フック `useConditionalPolling`

```typescript
// apps/web/src/hooks/use-conditional-polling.ts
export function useConditionalPolling<T>({
  endpoint,
  condition,
  onUpdate,
  waitTimeoutSec = 120,
  enabled = true,
}: ConditionalPollingOptions<T>) {
  // ページフォーカス検知
  // 条件評価
  // ロング・ポーリング実行
  // エラーハンドリング
}
```

#### 2.2 チーム申請専用フック

```typescript
// apps/web/src/hooks/use-team-applications-polling.ts
export function useTeamApplicationsPolling(customUrl: string) {
  const { user } = useAuth();
  const { data: teamDetail } = useTeamDetail(customUrl);

  return useConditionalPolling({
    endpoint: `/teams/${customUrl}/wait-updates`,
    condition: () => {
      return Boolean(teamDetail?.role === "admin" && document.hasFocus());
    },
    onUpdate: (updates) => {
      // React Query キャッシュ更新
      queryClient.invalidateQueries(["team-applications", customUrl]);

      // 通知表示
      showNotification({
        title: "新しい申請",
        message: `${updates.newApplications.length}件の新規申請があります`,
        type: "info",
      });
    },
  });
}
```

#### 2.3 UI統合

**TeamDetail コンポーネント統合**:

```typescript
// apps/web/components/features/team/team-detail.tsx に統合
export function TeamDetail({ customUrl }: { customUrl: string }) {
  // 既存ロジック...

  // 条件付きポーリング開始
  useTeamApplicationsPolling(customUrl);

  // 既存JSX...
}
```

## 📊 パフォーマンス最適化

### リソース使用量予測

**従来のポーリング（30秒間隔）vs 条件付きロング・ポーリング**:

| 指標             | 従来  | 条件付きLP | 削減率 |
| ---------------- | ----- | ---------- | ------ |
| API呼び出し/時間 | 120回 | 0.5-2回    | 98.3%  |
| サーバー負荷     | 高    | 極小       | 95%+   |
| 通信量           | 多    | 最小限     | 90%+   |

### スケーラビリティ

- **1000チーム同時**: 従来120,000リクエスト/時 → 条件付きLP 500-2,000リクエスト/時
- **メモリ使用量**: 待機コネクション管理（Cloudflare Workers対応）

## 🚀 段階的実装プラン

### Step 1: サーバーサイド基盤

1. `wait-updates` エンドポイント作成
2. 権限チェック機能実装
3. 効率的DB クエリ実装

### Step 2: クライアントサイド基盤

1. `useConditionalPolling` 汎用フック作成
2. ページフォーカス検知機能
3. エラーハンドリング & リトライ機能

### Step 3: 機能統合

1. `useTeamApplicationsPolling` 専用フック
2. TeamDetail コンポーネント統合
3. UI通知システム連携

### Step 4: テスト & 調整

1. 管理者権限でのテスト
2. 非管理者でのアクセス制御テスト
3. パフォーマンス測定 & 調整

## 🎯 期待効果

1. **真のリアルタイム体験**: 新規申請から1-3秒以内で通知
2. **サーバー負荷激減**: 98%以上のAPI呼び出し削減
3. **汎用性**: メモ更新、タスク変更等への横展開可能
4. **開発体験向上**: 開発環境でのエラー回避

## 🔍 実装後の拡張可能性

- **メモリアルタイム同期**: `useConditionalPolling` 再利用
- **タスク進捗通知**: 同一パターンで実装可能
- **チームメンバー変更通知**: 管理者向け追加通知
- **マルチチーム対応**: 複数チーム同時監視

---

> **設計思想**: 必要な時だけ、必要な人だけが、必要最小限のリソースで、最大限のリアルタイム体験を提供
