# データベーステーブル設計詳細

## 既存システムの整合性分析

### 既存パターンの統一
- **タイムスタンプ**: `integer`型 + `{ mode: "timestamp" }` + `sql`(unixepoch())`
- **ID**: `integer`型 + `primaryKey({ autoIncrement: true })`
- **ユーザーID**: `text("user_id").notNull()`
- **originalId**: `text("original_id").notNull()` (メモ・タスクのみ)
- **削除テーブル**: 元テーブル + `deletedAt`フィールド

## 1. タグシステム テーブル設計

### tagsテーブル (タグマスター)
```typescript
// apps/api/src/db/schema/tags.ts
import { sqliteTable, text, integer } from "drizzle-orm/sqlite-core";
import { sql } from "drizzle-orm";

export const tags = sqliteTable("tags", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  color: text("color"), // hex形式 例: "#3B82F6"
  userId: text("user_id").notNull(),
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`)
    .$onUpdate(() => new Date()),
});

// ユニークインデックス: ユーザー毎にタグ名は一意
// CREATE UNIQUE INDEX idx_tags_user_name ON tags(user_id, name);
```

### taggingsテーブル (タグ付け中間テーブル)
```typescript
export const taggings = sqliteTable("taggings", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  tagId: integer("tag_id").notNull().references(() => tags.id, { onDelete: "cascade" }),
  targetType: text("target_type").notNull(), // 'memo' | 'task' | 'board'
  targetOriginalId: text("target_original_id").notNull(), // 対象のoriginalId
  userId: text("user_id").notNull(), // パフォーマンス向上のため重複保存
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
});

// 複合ユニークインデックス: 同じアイテムに同じタグは1つまで
// CREATE UNIQUE INDEX idx_taggings_unique ON taggings(tag_id, target_type, target_original_id);
// 検索用インデックス
// CREATE INDEX idx_taggings_target ON taggings(target_type, target_original_id);
// CREATE INDEX idx_taggings_user ON taggings(user_id);
```

### 型定義
```typescript
export type Tag = typeof tags.$inferSelect;
export type NewTag = typeof tags.$inferInsert;
export type Tagging = typeof taggings.$inferSelect;
export type NewTagging = typeof taggings.$inferInsert;
```

## 2. ボードカテゴリー テーブル設計

### boardCategoriesテーブル ✅ **実装済み（ボード専用カテゴリー）**
```typescript
// apps/api/src/db/schema/board-categories.ts
import { sqliteTable, text, integer } from "drizzle-orm/sqlite-core";
import { sql } from "drizzle-orm";

export const boardCategories = sqliteTable("board_categories", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  boardId: integer("board_id").notNull(), // ★ボード専用カテゴリー
  icon: text("icon"), // アイコン名 例: "folder", "project"
  sortOrder: integer("sort_order").notNull().default(0), // 表示順序
  userId: text("user_id").notNull(),
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`)
    .$onUpdate(() => new Date()),
});

// インデックス: ボード毎にカテゴリー管理
// CREATE INDEX idx_board_categories_board ON board_categories(board_id, sort_order);
// CREATE INDEX idx_board_categories_user ON board_categories(user_id);
```

### tasksテーブル拡張 ✅ **実装済み**
```typescript
// apps/api/src/db/schema/tasks.ts に追加
export const tasks = sqliteTable("tasks", {
  // 既存フィールド...
  id: integer("id").primaryKey({ autoIncrement: true }),
  originalId: text("original_id").notNull(),
  title: text("title").notNull(),
  description: text("description"),
  status: text("status").notNull(),
  priority: text("priority").notNull(),
  dueDate: integer("due_date", { mode: "timestamp" }),
  categoryId: integer("category_id"),
  userId: text("user_id").notNull(),
  
  // ★新規追加（ボードカテゴリーでタスク分類）
  boardCategoryId: integer("board_category_id"),
  
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`)
    .$onUpdate(() => new Date()),
});

// インデックス追加
// CREATE INDEX idx_tasks_board_category ON tasks(board_category_id);
```

### deletedTasksテーブル拡張 ✅ **実装済み**
```typescript
export const deletedTasks = sqliteTable("deleted_tasks", {
  // 既存フィールド...
  id: integer("id").primaryKey({ autoIncrement: true }),
  userId: text("user_id").notNull(),
  originalId: text("original_id").notNull(),
  title: text("title").notNull(),
  description: text("description"),
  status: text("status").notNull(),
  priority: text("priority").notNull(),
  dueDate: integer("due_date", { mode: "timestamp" }),
  categoryId: integer("category_id"),
  
  // ★新規追加（削除時にボードカテゴリー情報も保存）
  boardCategoryId: integer("board_category_id"),
  
  createdAt: integer("created_at").notNull(),
  updatedAt: integer("updated_at"),
  deletedAt: integer("deleted_at").notNull(), // 削除日時
});
```

### 型定義 ✅ **実装済み**
```typescript
export type BoardCategory = typeof boardCategories.$inferSelect;
export type NewBoardCategory = typeof boardCategories.$inferInsert;

// Task型の拡張（ボードカテゴリー対応）✅ **実装済み**
export type Task = typeof tasks.$inferSelect & {
  boardCategoryId: number | null; // ボードカテゴリーID
};

export type CreateTaskData = {
  // ... 既存フィールド
  boardCategoryId?: number | null; // ボードカテゴリーID
};

export type UpdateTaskData = {
  // ... 既存フィールド
  boardCategoryId?: number | null; // ボードカテゴリーID
};
```

## 3. 重要な設計判断

### originalIdの扱い
- **ボード**: 既存システムでは`boards.id`を直接使用
- **タグ付け**: `targetOriginalId`でメモ・タスク・ボードを統一的に扱う
- **ボードのoriginalId**: `board.id.toString()`として生成

### タイムスタンプの統一
```typescript
// 既存パターンに合わせた統一形式
createdAt: integer("created_at", { mode: "timestamp" })
  .notNull()
  .default(sql`(unixepoch())`),
updatedAt: integer("updated_at", { mode: "timestamp" })
  .notNull()
  .default(sql`(unixepoch())`)
  .$onUpdate(() => new Date()),
```

### 外部キー制約の戦略
- **tags → taggings**: `onDelete: "cascade"` (タグ削除時にタグ付けも削除)
- **boardCategories → tasks**: 外部キー制約なし（ボード専用カテゴリーのため、boardIdベースで管理）

### インデックス戦略
```sql
-- タグ系
CREATE UNIQUE INDEX idx_tags_user_name ON tags(user_id, name);
CREATE UNIQUE INDEX idx_taggings_unique ON taggings(tag_id, target_type, target_original_id);
CREATE INDEX idx_taggings_target ON taggings(target_type, target_original_id);
CREATE INDEX idx_taggings_user ON taggings(user_id);

-- ボードカテゴリー系  
CREATE INDEX idx_board_categories_board ON board_categories(board_id, sort_order);
CREATE INDEX idx_board_categories_user ON board_categories(user_id);
CREATE INDEX idx_tasks_board_category ON tasks(board_category_id);
```

## 4. Drizzleスキーマファイル構成

### ファイル構造
```
apps/api/src/db/schema/
├── memos.ts              # 既存
├── tasks.ts              # 既存  
├── boards.ts             # 既存 + boardCategoryId追加
├── categories.ts         # 既存
├── user-preferences.ts   # 既存
├── tags.ts               # 新規
└── board-categories.ts   # 新規
```

### index.tsの更新
```typescript
// apps/api/src/db/index.ts
export * from "./schema/memos";
export * from "./schema/tasks";
export * from "./schema/user-preferences";
export * from "./schema/categories";
export * from "./schema/boards";
export * from "./schema/tags";              // 新規追加
export * from "./schema/board-categories";  // 新規追加
```

## 5. マイグレーション考慮事項

### 段階的追加戦略 ✅ **ボードカテゴリー完了**
1. **Phase 1**: `tags`, `taggings`テーブル作成 ✅ 完了
2. ✅ **Phase 2**: `board_categories`テーブル作成（ボード専用カテゴリー）
3. ✅ **Phase 3**: `tasks`テーブルに`board_category_id`追加
4. ✅ **Phase 4**: `deleted_tasks`テーブルに`board_category_id`追加

### 既存データへの影響
- 既存のmemos, tasksテーブルに影響なし
- ✅ `tasks.boardCategoryId`は`NULL`許可で既存データ影響なし
- ✅ `deleted_tasks.boardCategoryId`も`NULL`許可で後方互換性確保

## 6. パフォーマンス最適化

### クエリパターン最適化
```sql
-- よく使われるクエリパターン
-- 1. 特定アイテムのタグ一覧
SELECT t.* FROM tags t 
JOIN taggings tg ON t.id = tg.tag_id 
WHERE tg.target_type = ? AND tg.target_original_id = ?;

-- 2. 特定タグのアイテム一覧
SELECT tg.target_type, tg.target_original_id 
FROM taggings tg 
WHERE tg.tag_id = ?;

-- 3. ボードカテゴリー別タスク一覧 ✅ **実装済み**
SELECT t.*, bc.name as category_name 
FROM tasks t 
LEFT JOIN board_categories bc ON t.board_category_id = bc.id 
WHERE t.board_category_id = ?;
```

### メモリ使用量対策
- `userId`の重複保存でJOIN回数削減
- 適切なインデックスでテーブルスキャン回避
- ページネーション前提の設計

## 7. 実装優先順位

### 必須実装 ✅ **ボードカテゴリー完了**
1. ✅ `tags`テーブル + 基本CRUD
2. ✅ `taggings`テーブル + 基本操作
3. ✅ `board_categories`テーブル + 基本CRUD（ボード専用）
4. ✅ `tasks.boardCategoryId`追加

### 段階的実装 🔶 **部分完了**
1. ✅ メモ・タスクのタグ機能
2. ❌ ボードのタグ機能（未実装）
3. ✅ ボードカテゴリー機能（完全実装済み）
4. ❌ 横断検索機能（未実装）

## 8. ✅ 2025/08/16 ボードカテゴリー実装完了
### 実装された機能
- **ボード専用カテゴリーシステム**: 各ボードが独自のカテゴリー体系を持つ
- **タスクのカテゴリー分類**: boardCategoryIdでタスクを分類可能
- **完全なCRUD操作**: 作成・読み取り・更新・削除・並び替え
- **UI統合**: TaskEditor、BoardCategoryManager実装完了
- **変更検知**: カテゴリー変更のみでも保存可能

この設計で問題ありませんか？特に気になる点や変更したい部分があればお知らせください。