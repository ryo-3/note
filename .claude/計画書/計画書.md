# チーム機能 - データベース設計計画書

## 基本方針
- 個人用とチーム用テーブルを完全分離
- 既存の個人用機能への影響を最小限に
- シンプルで理解しやすい構造を優先

## テーブル設計

### 1. チーム管理テーブル（新規）

#### teams
```sql
teams {
  id: integer (primary key, autoIncrement)
  name: text (not null) - チーム名
  description: text - チーム説明
  createdAt: integer (not null) - 作成日時
  updatedAt: integer - 更新日時
}
```

#### team_members
```sql
team_members {
  id: integer (primary key, autoIncrement)
  teamId: integer (not null, foreign key to teams.id)
  userId: text (not null) - Clerk user ID
  role: text (not null, default "member") - "admin" | "member"
  joinedAt: integer (not null) - 参加日時
}
```

#### team_invitations
```sql
team_invitations {
  id: integer (primary key, autoIncrement)
  teamId: integer (not null, foreign key to teams.id)
  email: text (not null) - 招待先メールアドレス
  role: text (not null, default "member") - "admin" | "member"
  token: text (not null) - 招待トークン（UUID等）
  invitedBy: text (not null) - 招待者のuser ID
  createdAt: integer (not null) - 招待日時
  expiresAt: integer (not null) - 有効期限
  status: text (not null, default "pending") - "pending" | "accepted" | "expired"
}
```

### 2. チーム用コンテンツテーブル（新規）

#### team_memos
```sql
team_memos {
  id: integer (primary key, autoIncrement)
  teamId: integer (not null, foreign key to teams.id)
  userId: text (not null) - 作成者のuser ID
  originalId: text (not null) - オリジナルID（削除・復元管理用）
  uuid: text - 将来用UUID（オプショナル）
  title: text (not null) - タイトル
  content: text - 本文
  categoryId: integer - カテゴリーID（将来拡張用）
  createdAt: integer (not null) - 作成日時
  updatedAt: integer - 更新日時
}
```

#### team_deleted_memos
```sql
team_deleted_memos {
  id: integer (primary key, autoIncrement)
  teamId: integer (not null)
  userId: text (not null) - 作成者のuser ID
  originalId: text (not null) - 元のteam_memosのoriginalId
  uuid: text - 将来用UUID（オプショナル）
  title: text (not null)
  content: text
  categoryId: integer
  createdAt: integer (not null)
  updatedAt: integer
  deletedAt: integer (not null) - 削除日時
}
```

#### team_tasks
```sql
team_tasks {
  id: integer (primary key, autoIncrement)
  teamId: integer (not null, foreign key to teams.id)
  userId: text (not null) - 作成者のuser ID
  originalId: text (not null) - オリジナルID（削除・復元管理用）
  uuid: text - 将来用UUID（オプショナル）
  title: text (not null) - タイトル
  description: text - 説明
  status: text (not null, default "todo") - "todo" | "in_progress" | "completed"
  priority: text (not null, default "medium") - "low" | "medium" | "high"
  dueDate: integer - 期限（Unix timestamp）
  categoryId: integer - カテゴリーID
  boardCategoryId: integer - ボードカテゴリーID
  createdAt: integer (not null) - 作成日時
  updatedAt: integer - 更新日時
}
```

#### team_deleted_tasks
```sql
team_deleted_tasks {
  id: integer (primary key, autoIncrement)
  teamId: integer (not null)
  userId: text (not null) - 作成者のuser ID
  originalId: text (not null) - 元のteam_tasksのoriginalId
  uuid: text - 将来用UUID（オプショナル）
  title: text (not null)
  description: text
  status: text (not null)
  priority: text (not null)
  dueDate: integer
  categoryId: integer
  boardCategoryId: integer
  createdAt: integer (not null)
  updatedAt: integer
  deletedAt: integer (not null) - 削除日時
}
```

### 3. 既存テーブル（変更なし）
- `memos` - 個人用メモ
- `deleted_memos` - 個人用削除済みメモ
- `tasks` - 個人用タスク  
- `deleted_tasks` - 個人用削除済みタスク
- その他既存テーブル

## 権限設計

### 権限レベル（2段階）
- **admin**: メンバー招待、チーム設定変更、コンテンツ管理
- **member**: メモ・タスクの作成・編集・削除

### 権限チェックロジック
1. ユーザーがそのチームのメンバーかチェック（team_members）
2. 必要に応じて権限レベルをチェック
3. コンテンツ操作時はteamIdで適切なテーブルにアクセス

## 実装順序（案）
1. チーム管理テーブルのスキーマ作成・マイグレーション
2. チーム用コンテンツテーブルのスキーマ作成・マイグレーション
3. チーム作成・管理API実装
4. チーム招待機能API実装  
5. チーム用メモ・タスクAPI実装
6. フロントエンド統合

## 注意点
- 既存の個人用機能には一切変更を加えない
- originalId管理システムは既存のものと同じ仕組みを使用
- チーム削除時のカスケード処理を考慮
- 招待トークンの有効期限・セキュリティを考慮