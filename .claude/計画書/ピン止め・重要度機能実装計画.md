# ピン止め・重要度機能実装計画

## 1. 概要

メモとタスクにピン止め機能と重要度機能を追加し、より効率的な情報管理を実現する。

### 機能の違い
- **ピン止め**: 表示順序の制御（重要なアイテムを一番上に固定表示）
- **重要度**: コンテンツの分類（通常・重要でタブ分け）

## 2. データベース設計

### memosテーブル拡張
```sql
ALTER TABLE memos ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0;
ALTER TABLE memos ADD COLUMN pinned_at INTEGER;
ALTER TABLE memos ADD COLUMN importance TEXT NOT NULL DEFAULT 'normal';
ALTER TABLE memos ADD COLUMN pin_order INTEGER;
```

### deleted_memosテーブル拡張
```sql
ALTER TABLE deleted_memos ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0;
ALTER TABLE deleted_memos ADD COLUMN pinned_at INTEGER;
ALTER TABLE deleted_memos ADD COLUMN importance TEXT NOT NULL DEFAULT 'normal';
ALTER TABLE deleted_memos ADD COLUMN pin_order INTEGER;
```

### tasksテーブル拡張
```sql
ALTER TABLE tasks ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0;
ALTER TABLE tasks ADD COLUMN pinned_at INTEGER;
ALTER TABLE tasks ADD COLUMN importance TEXT NOT NULL DEFAULT 'normal';
ALTER TABLE tasks ADD COLUMN pin_order INTEGER;
```

### deleted_tasksテーブル拡張
```sql
ALTER TABLE deleted_tasks ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0;
ALTER TABLE deleted_tasks ADD COLUMN pinned_at INTEGER;
ALTER TABLE deleted_tasks ADD COLUMN importance TEXT NOT NULL DEFAULT 'normal';
ALTER TABLE deleted_tasks ADD COLUMN pin_order INTEGER;
```

### カラム詳細
```typescript
interface PinImportanceFields {
  isPinned: number;           // 0: false, 1: true
  pinnedAt: number | null;    // ピン止めした日時（Unix timestamp）
  importance: 'normal' | 'important'; // 重要度
  pinOrder: number | null;    // ピン止め内での順序（将来用）
}
```

## 3. UI設計

### タブ構成
```
[すべて] [通常] [重要] [削除済み]
```

### 表示順序ルール
1. **ピン止めアイテム**（`isPinned = 1`）
   - `pinOrder` ASC（将来実装）
   - `pinnedAt` DESC（現在はこれで十分）
2. **通常アイテム**（`isPinned = 0`）
   - 既存の並び順設定に従う

### ピン止めアイコン表示
- メモ一覧・タスク一覧でピンアイコン表示
- ピン止め済みは塗りつぶし、未ピン止めは枠線のみ

## 4. API設計

### ピン止め操作API
```typescript
// ピン止め切り替え
PUT /memos/{originalId}/pin
PUT /tasks/{originalId}/pin
{
  "isPinned": boolean
}

// 重要度変更
PUT /memos/{originalId}/importance
PUT /tasks/{originalId}/importance
{
  "importance": "normal" | "important"
}
```

### 一括操作API
```typescript
// 一括ピン止め
PUT /memos/bulk-pin
PUT /tasks/bulk-pin
{
  "originalIds": string[],
  "isPinned": boolean
}

// 一括重要度変更
PUT /memos/bulk-importance
PUT /tasks/bulk-importance
{
  "originalIds": string[],
  "importance": "normal" | "important"
}
```

## 5. フロントエンド実装

### 型定義拡張
```typescript
// apps/web/src/types/memo.ts
interface MemoBase {
  // ... 既存フィールド
  isPinned: boolean;
  pinnedAt: Date | null;
  importance: 'normal' | 'important';
  pinOrder: number | null;
}

// apps/web/src/types/task.ts
interface TaskBase {
  // ... 既存フィールド
  isPinned: boolean;
  pinnedAt: Date | null;
  importance: 'normal' | 'important';
  pinOrder: number | null;
}
```

### React Query フック拡張
```typescript
// useMemos.ts
export const usePinMemo = () => {
  return useMutation({
    mutationFn: async ({ originalId, isPinned }: { originalId: string, isPinned: boolean }) => {
      // API呼び出し
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['memos']);
    }
  });
};

export const useUpdateMemoImportance = () => {
  return useMutation({
    mutationFn: async ({ originalId, importance }: { originalId: string, importance: string }) => {
      // API呼び出し
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['memos']);
    }
  });
};
```

### 複数選択メニュー拡張
```typescript
// SelectionMenuButton に追加
onPin: () => void;              // 一括ピン止め
onImportanceToggle: () => void; // 一括重要度切り替え
```

## 6. 実装フェーズ

### Phase 1: データベース拡張
1. マイグレーションスクリプト作成
2. Drizzle スキーマ更新
3. 型定義更新

### Phase 2: バックエンド実装
1. 単体操作API実装
2. 一括操作API実装
3. 既存API（一覧取得）の並び順対応

### Phase 3: フロントエンド基本機能
1. 型定義・React Query フック更新
2. ピンアイコン表示
3. 単体ピン止め操作

### Phase 4: タブ機能拡張
1. 重要度タブ追加
2. タブ切り替えロジック更新
3. 表示順序ロジック実装

### Phase 5: 一括操作機能
1. 複数選択メニューにピン止め追加
2. 複数選択メニューに重要度切り替え追加
3. 一括操作API連携

### Phase 6: 高度な機能
1. ピン止め順序変更（ドラッグ&ドロップ）
2. 重要度自動判定（AI活用）
3. ピン止め・重要度の統計表示

## 7. 技術的考慮事項

### パフォーマンス最適化
- インデックス追加
```sql
CREATE INDEX idx_memos_user_pin_importance ON memos(userId, isPinned, importance);
CREATE INDEX idx_tasks_user_pin_importance ON tasks(userId, isPinned, importance);
```

### 並び順クエリ最適化
```sql
-- メモ一覧取得（ピン止め優先）
SELECT * FROM memos 
WHERE userId = ? AND importance = ?
ORDER BY 
  isPinned DESC,
  CASE WHEN isPinned = 1 THEN pinnedAt END DESC,
  CASE WHEN isPinned = 0 THEN createdAt END DESC;
```

### React Query キャッシュ戦略
- タブ別キャッシュ管理
- ピン止め操作時の即座な UI 更新
- 楽観的更新の実装

## 8. ユーザビリティ

### ピン止め操作
- **メイン画面**: アイテムクリック時にピンアイコン表示
- **複数選択**: 選択メニューからピン止め
- **エディター**: 右上にピンアイコン配置

### 重要度操作
- **複数選択**: 選択メニューから重要度切り替え
- **エディター**: 重要度ボタン配置
- **自動判定**: キーワード・期限による自動重要度設定

### 視覚的フィードバック
- ピン止めアイテムに特別なスタイル
- 重要アイテムに警告色・アイコン
- アニメーション効果

## 9. マイグレーション戦略

### 既存データへの影響
- すべての既存アイテムは `importance = 'normal'`、`isPinned = 0`
- 段階的な機能追加で影響最小化
- 既存API互換性維持

### ロールバック対応
- 機能無効化フラグ
- データベーススキーマのバックアップ
- API バージョニング

## 10. テスト計画

### 単体テスト
- ピン止め操作API
- 重要度変更API
- 並び順ロジック

### 統合テスト
- タブ切り替え
- 複数選択操作
- データ整合性

### E2Eテスト
- ユーザーフロー全体
- パフォーマンステスト
- ブラウザ互換性

## 11. 成功指標

### 機能指標
- ピン止め機能の使用率
- 重要度機能の使用率
- タブ切り替え頻度

### パフォーマンス指標
- 一覧表示速度
- 操作レスポンス時間
- データベース負荷

### ユーザビリティ指標
- 機能発見率
- 操作成功率
- ユーザー満足度