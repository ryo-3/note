# BoardDetailScreen リファクタリング計画書

## 現状分析

### ファイルの現状

- **ファイルサイズ**: 885行（過大）
- **主な責任**: 10以上の責任を持つ単一コンポーネント
- **問題点**: 保守性の低下、テストの困難さ、可読性の悪化

### 現在の機能構成

1. 状態管理（複数選択、タブ、表示モード）
2. データ取得・計算（メモ・タスクの件数・フィルタリング）
3. 選択操作ハンドラー（単体選択、複数選択、全選択）
4. 削除操作（一括削除、個別削除、ボードから削除）
5. 新規作成・編集操作
6. ボード操作（アイテム追加・削除・エクスポート）
7. レイアウト・UI制御
8. エフェクト管理（タイトル設定、選択状態クリーンアップ）

## リファクタリング戦略

### 目標

- **885行 → 約400行**に削減
- 単一責任原則の適用
- 既存コンポーネントとの統合促進
- 保守性・可読性の向上

### 優先順位と段階的実装

#### Phase 1: 即座に適用可能（高効果・低リスク）

##### 1-1. use-select-all.ts の導入 🟢

- **対象**: 621-641行の全選択ロジック
- **削減見込み**: 40-50行
- **リスク**: 低（既存フックの活用）
- **工期**: 30分

```typescript
// 置き換え対象
const handleMemoSelectAll = useCallback(() => {
  const currentMemoIds = memoItems.map((item) => item.itemId);
  if (checkedMemos.size === currentMemoIds.length) {
    setCheckedMemos(new Set());
  } else {
    setCheckedMemos(new Set(currentMemoIds));
  }
}, [memoItems, checkedMemos.size, setCheckedMemos]);
```

##### 1-2. SelectionModeToggle コンポーネント統合 🟢

- **対象**: 選択モード切り替えUI
- **削減見込み**: 10-15行
- **リスク**: なし（既存コンポーネント）
- **工期**: 15分

##### 1-3. BulkActionButtons コンポーネント統合 🟢

- **対象**: 一括操作ボタン部分
- **削減見込み**: 20-30行
- **リスク**: 低（プロパティ調整のみ）
- **工期**: 45分

#### Phase 2: カスタムフック抽出（中効果・中リスク）

##### 2-1. useMultiSelection フック作成 🟡

- **対象**: 92-148行の複数選択状態管理
- **削減見込み**: 80-100行
- **リスク**: 中（複雑な状態管理）
- **工期**: 2時間

```typescript
// 抽出対象
const [selectionMode, setSelectionMode] = useState<"select" | "check">(
  "select",
);
const [checkedNormalMemos, setCheckedNormalMemos] = useState<
  Set<string | number>
>(new Set());
const [checkedDeletedMemos, setCheckedDeletedMemos] = useState<
  Set<string | number>
>(new Set());
const [checkedTasks, setCheckedTasks] = useState<Set<string | number>>(
  new Set(),
);
```

##### 2-2. useBoardSelectionHandlers フック作成 🟡

- **対象**: 114-148行の選択ハンドラー群
- **削減見込み**: 60-80行
- **リスク**: 中（依存関係の整理が必要）
- **工期**: 1.5時間

##### 2-3. useBulkDeleteOperations フック作成 🟡

- **対象**: 154-226行の削除操作ロジック
- **削減見込み**: 100-120行
- **リスク**: 中（アニメーション・API連携）
- **工期**: 2.5時間

#### Phase 3: データ処理抽出（低効果・低リスク）

##### 3-1. useBoardItems フック作成 🔵

- **対象**: 404-440行のアイテム計算・フィルタリング
- **削減見込み**: 60-80行
- **リスク**: 低（純粋な計算ロジック）
- **工期**: 1時間

##### 3-2. useBoardOperations フック作成 🔵

- **対象**: ボード操作関連（追加・削除・エクスポート）
- **削減見込み**: 40-60行
- **リスク**: 低（APIコール集約）
- **工期**: 1時間

#### Phase 4: UI コンポーネント抽出（追加価値）

##### 4-1. FloatingBackButton コンポーネント作成 🟣

- **対象**: 813-834行のフローティングボタン
- **削減見込み**: 25行
- **リスク**: なし（単純UI）
- **工期**: 30分
- **追加価値**: 他画面での再利用可能

## 既存コンポーネント統合状況

### ✅ 既に最適統合済み

- `use-board-state.ts` - 完全活用
- `use-deleted-item-operations.ts` - 適切利用
- `domUtils.ts` - DOM順序管理で活用
- `BulkDeleteConfirmation` - モーダルで使用

### 🟢 即座に統合可能

- `use-select-all.ts` - 高い互換性
- `SelectionModeToggle` - そのまま使用可能
- `BulkActionButtons` - 軽微調整で対応

### 🟡 カスタマイズ統合

- `use-selection-handlers.ts` - 基本ロジック共通
- `use-screen-state.ts` - パターン参考

## 実装計画

### Week 1: Phase 1 実装

- Day 1: use-select-all.ts 導入
- Day 2: SelectionModeToggle 統合
- Day 3: BulkActionButtons 統合
- **成果**: 100-120行削減、即座の効果実感

### Week 2: Phase 2 実装

- Day 1-2: useMultiSelection フック作成
- Day 3: useBoardSelectionHandlers フック作成
- Day 4-5: useBulkDeleteOperations フック作成
- **成果**: 240-300行削減、大幅な構造改善

### Week 3: Phase 3-4 実装

- Day 1: useBoardItems フック作成
- Day 2: useBoardOperations フック作成
- Day 3: FloatingBackButton コンポーネント作成
- Day 4-5: 最終調整・テスト・型チェック
- **成果**: 125-165行削減、完全なリファクタリング完了

## 期待効果

### 定量効果

- **行数削減**: 885行 → 約400行（45%削減）
- **責任分離**: 10責任 → 3-4責任
- **再利用性**: 5つの新規フック・コンポーネント作成

### 定性効果

- **保守性向上**: 単一責任による修正容易性
- **テスト性向上**: フック単位でのテスト可能
- **可読性向上**: 複雑なロジックの分離
- **再利用促進**: 他画面での活用可能

## リスク管理

### 高リスク要素

- 複数選択状態管理の複雑さ（タブ横断）
- 削除操作のアニメーション連携
- Fast Refresh との互換性

### 対策

- 段階的実装による影響範囲限定
- 既存の動作を完全に再現する詳細テスト
- TypeScript 型チェックによる安全性確保

## 成功指標

### 技術指標

- [ ] 行数を400行以下に削減
- [ ] 型エラー・lintエラーが0件
- [ ] 既存の全機能が正常動作
- [ ] Fast Refresh が正常動作

### 品質指標

- [ ] 単一責任原則の遵守
- [ ] 新規フック・コンポーネントの再利用実現
- [ ] コードレビューでの可読性評価向上

---

**作成日**: 2025-07-23  
**更新日**: -  
**担当**: Claude Code  
**レビュー**: 未実施
