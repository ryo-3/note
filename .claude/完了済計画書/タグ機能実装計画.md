# タグ機能実装計画

## 概要

メモ、タスク、ボードを横断的に分類・検索できるタグ機能を実装する。
カテゴリーとは独立した分類システムとして、複数のタグを1つのアイテムに付与可能。

## 現状分析

### 既存データベース構造

- **memos**: `categoryId` による単一カテゴリー分類
- **tasks**: `categoryId` による単一カテゴリー分類
- **boards**: カテゴリー機能なし
- **categories**: 全体共通のカテゴリーシステム
- **boardItems**: メモ・タスクをボードに追加する中間テーブル

### 既存の分類システム

- カテゴリー: 1対1の関係（単一カテゴリーのみ）
- ボード: メモ・タスクをボードに追加する機能

## タグシステム設計

### 1. データベース設計

#### タグマスターテーブル

```sql
-- tags テーブル
CREATE TABLE tags (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  color TEXT, -- UIでの表示色（オプション）
  userId TEXT NOT NULL,
  createdAt INTEGER NOT NULL,
  updatedAt INTEGER
);

-- ユニークインデックス（ユーザー毎にタグ名は一意）
CREATE UNIQUE INDEX idx_tags_user_name ON tags(userId, name);
```

#### タグ付けテーブル（多対多関係）

```sql
-- taggings テーブル（タグ付け中間テーブル）
CREATE TABLE taggings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  tagId INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
  targetType TEXT NOT NULL, -- 'memo' | 'task' | 'board'
  targetOriginalId TEXT NOT NULL, -- 対象のoriginalId
  userId TEXT NOT NULL,
  createdAt INTEGER NOT NULL
);

-- 複合ユニークインデックス（同じアイテムに同じタグは1つまで）
CREATE UNIQUE INDEX idx_taggings_unique ON taggings(tagId, targetType, targetOriginalId);
-- 検索用インデックス
CREATE INDEX idx_taggings_target ON taggings(targetType, targetOriginalId);
CREATE INDEX idx_taggings_user ON taggings(userId);
```

### 2. API設計

#### タグ管理API

```
GET    /tags                    # タグ一覧取得
POST   /tags                    # タグ作成
PUT    /tags/{id}               # タグ更新
DELETE /tags/{id}               # タグ削除（関連するタグ付けも削除）
```

#### タグ付けAPI

```
GET    /taggings                # タグ付け一覧（フィルター可能）
POST   /taggings                # タグ付け追加
DELETE /taggings/{id}           # タグ付け削除

# パラメータ例
GET /taggings?targetType=memo&targetOriginalId=123
GET /taggings?tagId=456
```

#### 検索API（既存APIに拡張）

```
GET /memos?tags=tag1,tag2       # タグでメモ検索
GET /tasks?tags=tag1,tag2       # タグでタスク検索
GET /boards?tags=tag1,tag2      # タグでボード検索
GET /search?q=keyword&tags=tag1 # 横断検索
```

### 3. フロントエンド設計

#### React Hooksの追加

```typescript
// apps/web/src/hooks/use-tags.ts
export function useTags() {
  // タグ一覧取得、作成、更新、削除
}

// apps/web/src/hooks/use-taggings.ts
export function useTaggings(targetType: string, targetOriginalId: string) {
  // 特定アイテムのタグ付け取得、追加、削除
}
```

#### UIコンポーネント

```typescript
// TagSelector - タグ選択・追加コンポーネント
// TagInput - 新規タグ入力
// TagChip - タグチップ表示
// TagFilter - タグによるフィルタリング
```

### 4. 実装ステップ

#### Phase 1: データベース・API

1. スキーマファイル作成: `apps/api/src/db/schema/tags.ts`
2. マイグレーション作成
3. タグ管理API実装: `/api/tags`
4. タグ付けAPI実装: `/api/taggings`

#### Phase 2: フロントエンド基盤

1. 型定義追加: `apps/web/src/types/tags.ts`
2. React Hooks実装
3. 基本UIコンポーネント実装

#### Phase 3: 各機能への統合

1. メモ画面にタグ機能追加
2. タスク画面にタグ機能追加
3. ボード画面にタグ機能追加
4. 検索機能拡張

#### Phase 4: 高度な機能

1. タグによる横断検索
2. タグ使用統計
3. タグ色分け・アイコン

#### Phase 5: スケーラビリティ対策

1. タグ数制限（ソフトリミット300個）
2. タグ検索・オートコンプリート機能
3. 未使用タグ検出・統合機能
4. 使用頻度順表示・お気に入りタグ

### 5. 既存システムとの関係

#### カテゴリーとの違い

- **カテゴリー**: 1対1関係、階層構造なし、必須ではない
- **タグ**: 多対多関係、フラット構造、オプション

#### originalIdシステムとの統合

- タグ付けでは`targetOriginalId`を使用
- 削除・復元時のタグ情報保持
- メモ/タスク/ボード横断での一意性確保

#### 削除システムとの統合

- アイテム削除時：タグ付けは残す（復元時に復活）
- タグ削除時：関連するタグ付けも削除（CASCADE）

### 6. パフォーマンス考慮

#### インデックス戦略

- `taggings(targetType, targetOriginalId)` - アイテム別タグ検索
- `taggings(tagId)` - タグ別アイテム検索
- `taggings(userId)` - ユーザー別絞り込み
- `tags(userId, name)` - タグ名の一意性制約

#### クエリ最適化

- JOINクエリでのN+1問題回避
- タグ付きアイテム一覧での適切な集約
- タグクラウド生成での効率的なカウント

### 7. UI/UX考慮事項

#### タグ入力方式

- オートコンプリート機能
- 既存タグからの選択
- 新規タグの即座作成

#### 表示方式

- タグチップでの視覚的表示
- タグによるフィルタリング
- タグクラウド表示

#### 操作性

- ドラッグ&ドロップでのタグ付け
- 一括タグ付け機能
- タグの並び順設定

### 8. スケーラビリティ・管理機能

#### タグ数制限・管理

- **ソフトリミット**: 1ユーザー300個
- **バリデーション**: タグ作成時に制限チェック
- **警告表示**: 制限に近づいた際のユーザー通知

#### タグ検索・オートコンプリート

```typescript
// タグ名での部分検索
GET /tags?q=keyword&limit=20

// 使用頻度順タグ取得
GET /tags?sort=usage&limit=50

// 最近使用したタグ
GET /tags?recent=true&limit=10
```

#### 未使用タグ管理

- **検出機能**: タグ付けされていないタグの一覧
- **削除提案**: 長期間未使用タグの削除提案
- **一括削除**: 選択した未使用タグの一括削除

#### タグ統合機能

- **重複検出**: 類似名タグの検出（typo等）
- **マージ機能**: 複数タグを1つに統合
- **影響確認**: 統合前の影響範囲表示

#### 使用統計・分析

```typescript
interface TagStats {
  id: number;
  name: string;
  usageCount: number;
  lastUsed: Date;
  itemTypes: { memo: number; task: number; board: number };
}

// API例
GET /tags/stats              # 全体統計
GET /tags/{id}/usage        # 特定タグの使用詳細
```

#### パフォーマンス最適化

- **キャッシュ戦略**: よく使用されるタグのキャッシュ
- **遅延読み込み**: タグ一覧のページネーション
- **バックグラウンド処理**: 統計情報の定期更新

#### モニタリング指標

- ユーザー毎のタグ数分布
- タグ使用頻度分布
- 未使用タグの割合
- タグ検索の応答時間

### 9. マイグレーション計画

#### 既存データへの影響

- 既存のカテゴリー機能は維持
- 新規タグシステムは完全に独立
- 段階的な機能追加で影響最小化

#### ロールバック対応

- タグ機能無効化フラグ
- データベーススキーマのバックアップ
- 段階的なテーブル削除手順

## 次ステップ

1. この計画の承認・修正
2. データベーススキーマの詳細設計
3. API仕様の詳細設計
4. 実装の優先順位決定
