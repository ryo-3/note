# ボードカテゴリー機能実装計画

## 実装完了 (2025-08-16)

ボード専用のカテゴリーシステムの実装が完了しました。
ただし、当初の設計から重要な変更があります：**ボードごとに独立したカテゴリー体系**として実装されました。

## 概要

各ボードが独自のカテゴリーを持つシステムとして実装。
ボード内のタスクを分類・整理するための機能として完成。

## 現状分析

### 既存システム

- **categories**: メモ・タスク用の全体共通カテゴリー
- **boards**: カテゴリー機能なし、`slug`による識別のみ
- ボードの整理方法: 現在は名前・作成日時による並び替えのみ

### 課題

- ボード数が増えた時の整理・分類方法がない

- プロジェクト別、用途別などの分類ができない
- 既存のカテゴリーはメモ・タスク用で用途が異なる

## 実装されたシステム設計

### 1. データベース設計（実装済み）

#### ボードカテゴリーテーブル（実装済み）

```sql
-- board_categories テーブル
CREATE TABLE board_categories (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  board_id INTEGER NOT NULL,  -- ★変更：ボード専用カテゴリー
  icon TEXT, -- アイコン名（オプション）
  userId TEXT NOT NULL,
  sortOrder INTEGER DEFAULT 0, -- 表示順序
  createdAt INTEGER NOT NULL,
  updatedAt INTEGER
);
-- ※ color, descriptionは実装から除外（シンプル化のため）
```

#### tasksテーブルの拡張（実装済み）

```sql
-- タスクにボードカテゴリーIDを追加
ALTER TABLE tasks ADD COLUMN board_category_id INTEGER;
ALTER TABLE deleted_tasks ADD COLUMN board_category_id INTEGER;
```

### 2. API設計（実装済み）

#### ボードカテゴリー管理API（実装済み）

```
GET    /board-categories?boardId={boardId}  # 特定ボードのカテゴリー一覧取得
POST   /board-categories                    # ボードカテゴリー作成
PUT    /board-categories/{id}               # ボードカテゴリー更新
DELETE /board-categories/{id}               # ボードカテゴリー削除
PUT    /board-categories/reorder            # カテゴリー並び順変更
```

#### タスクAPI拡張（実装済み）

```
POST   /tasks                               # boardCategoryId対応
PUT    /tasks/{id}                          # boardCategoryId更新対応
GET    /tasks                               # boardCategoryIdを含む
```

### 3. データ型定義（実装済み）

#### TypeScript型定義（実装済み）

```typescript
// apps/web/src/types/board-categories.ts
export interface BoardCategory {
  id: number;
  name: string;
  boardId: number; // ★追加：ボード専用
  icon?: string;
  userId: string;
  sortOrder: number;
  createdAt: Date;
  updatedAt?: Date;
}

export interface NewBoardCategory {
  name: string;
  boardId: number; // ★追加：ボード専用
  icon?: string;
  sortOrder?: number;
}

// task.tsの拡張（実装済み）
export interface Task {
  // 既存フィールド...
  boardCategoryId: number | null; // ★追加
}
```

### 4. フロントエンド設計

#### React Hooks

```typescript
// apps/web/src/hooks/use-board-categories.ts
export function useBoardCategories() {
  // カテゴリー一覧取得、作成、更新、削除、並び替え
}

// apps/web/src/hooks/use-boards.ts (拡張)
export function useBoards(categoryId?: number) {
  // カテゴリー別ボード取得に対応
}
```

#### UIコンポーネント

```typescript
// BoardCategorySelector - ボードカテゴリー選択
// BoardCategoryManager - カテゴリー管理画面
// BoardCategoryChip - カテゴリー表示チップ
// BoardCategoryFilter - カテゴリーフィルター
```

### 5. 実装完了項目

#### ✅ Phase 1: データベース・API基盤（完了）

1. ✅ スキーマファイル作成: `apps/api/src/db/schema/board-categories.ts`
2. ✅ tasksスキーマにboard_category_id追加
3. ✅ データベーススキーマ更新
4. ✅ ボードカテゴリーAPI実装: `/api/board-categories`
5. ✅ タスクAPI拡張: boardCategoryId対応

#### ✅ Phase 2: フロントエンド基盤（完了）

1. ✅ 型定義追加: `apps/web/src/types/board-categories.ts`
2. ✅ React Hooks実装: `use-board-categories.ts`
3. ✅ 基本UIコンポーネント実装

#### ✅ Phase 3: UI統合（完了）

1. ✅ タスクエディターでのカテゴリー選択機能
2. ✅ モーダル形式でのカテゴリー新規作成
3. ✅ ボード詳細画面でのカテゴリー表示

#### ✅ Phase 4: 管理機能（部分完了）

1. ✅ カテゴリー管理画面実装
2. ✅ カテゴリー並び替え機能（API実装済み）
3. ❌ カテゴリー色分け機能（実装から除外）

#### Phase 5: 高度な機能

1. カテゴリー別統計表示
2. カテゴリーのアーカイブ機能
3. カテゴリーのエクスポート・インポート

#### Phase 6: スケーラビリティ対策

1. カテゴリー数制限（ソフトリミット30個）
2. カテゴリー検索・オートコンプリート機能
3. 未使用カテゴリー検出・統合機能
4. 使用頻度順表示・お気に入りカテゴリー

### 6. 既存システムとの関係

#### 全体共通カテゴリーとの違い

- **全体共通カテゴリー**: メモ・タスク用、`categories`テーブル
- **ボードカテゴリー**: ボード専用、`board_categories`テーブル
- 完全に独立したシステム、相互影響なし

#### originalIdシステムとの統合

- ボードは既存のIDシステムを使用
- 削除・復元時のカテゴリー情報保持
- deletedBoardsテーブルでのカテゴリー情報保存

### 7. UI/UX設計

#### カテゴリー表示方式

- サイドバーでのカテゴリー別表示
- ボードカードでのカテゴリーバッジ表示
- カテゴリー色による視覚的分類

#### フィルタリング機能

- カテゴリー別フィルター
- 未分類ボード表示
- 複数カテゴリー同時表示

#### 管理画面

- ドラッグ&ドロップでの並び替え
- カテゴリー色・アイコン設定
- カテゴリー使用統計表示

### 8. スケーラビリティ・管理機能

#### カテゴリー数制限・管理

- **ソフトリミット**: 1ユーザー30個（ボードの大分類用）
- **バリデーション**: カテゴリー作成時に制限チェック
- **警告表示**: 制限に近づいた際のユーザー通知

#### カテゴリー検索・オートコンプリート

```typescript
// カテゴリー名での部分検索
GET /board-categories?q=keyword&limit=20

// 使用頻度順カテゴリー取得
GET /board-categories?sort=usage&limit=50

// 最近使用したカテゴリー
GET /board-categories?recent=true&limit=10
```

#### 未使用カテゴリー管理

- **検出機能**: ボードが設定されていないカテゴリーの一覧
- **削除提案**: 長期間未使用カテゴリーの削除提案
- **一括削除**: 選択した未使用カテゴリーの一括削除

#### カテゴリー統合機能

- **重複検出**: 類似名カテゴリーの検出
- **マージ機能**: 複数カテゴリーを1つに統合
- **影響確認**: 統合前の影響範囲表示（関連ボード数等）

#### 使用統計・分析

```typescript
interface BoardCategoryStats {
  id: number;
  name: string;
  boardCount: number;
  lastUsed: Date;
  archivedBoards: number;
  completedBoards: number;
}

// API例
GET /board-categories/stats           # 全体統計
GET /board-categories/{id}/usage     # 特定カテゴリーの使用詳細
```

#### パフォーマンス最適化

- **キャッシュ戦略**: よく使用されるカテゴリーのキャッシュ
- **遅延読み込み**: カテゴリー一覧のページネーション
- **バックグラウンド処理**: 統計情報の定期更新

#### モニタリング指標

- ユーザー毎のカテゴリー数分布
- カテゴリー使用頻度分布
- 未使用カテゴリーの割合
- カテゴリー検索の応答時間

### 9. パフォーマンス考慮

#### インデックス戦略

- `board_categories(userId, sortOrder)` - カテゴリー一覧表示用
- `boards(boardCategoryId)` - カテゴリー別ボード検索用
- `board_categories(userId, name)` - 名前重複チェック用

#### クエリ最適化

- JOINクエリでのカテゴリー情報取得
- カテゴリー別ボード数のカウント最適化
- キャッシュ戦略の検討

### 10. マイグレーション戦略

#### 既存データへの影響

- 既存ボードは`boardCategoryId = NULL`（未分類）
- 段階的な機能追加で影響最小化
- 既存API互換性維持

#### デフォルトカテゴリー

```sql
-- マイグレーション時にデフォルトカテゴリー作成（オプション）
INSERT INTO board_categories (name, description, userId, sortOrder, createdAt)
SELECT
  '未分類',
  'カテゴリーが設定されていないボード',
  DISTINCT userId,
  0,
  unixepoch()
FROM boards;
```

### 10. 拡張可能性

#### 将来的な機能拡張

- カテゴリー階層化（親子関係）
- カテゴリー別権限設定
- カテゴリーテンプレート機能
- 他システムとの連携

#### 他機能との連携

- タグシステムとの組み合わせ
- 検索機能での活用
- 統計・レポート機能

## 実装優先度

### 必須機能（MVP）

1. ボードカテゴリーマスター管理
2. ボードへのカテゴリー設定
3. カテゴリー別ボード表示
4. 基本的なCRUD操作

### 重要機能

1. カテゴリー並び替え
2. 色分け表示
3. 未分類ボード管理

### オプション機能

1. アイコン設定
2. 詳細な統計表示
3. 高度なフィルタリング

## 実装の要点と変更点

### 主要な設計変更

1. **ボード専用カテゴリー** → **ボードごとのカテゴリー体系**
   - 当初：全ボード共通のカテゴリーでボードを分類
   - 実装：各ボードが独自のカテゴリーを持ち、タスクを分類

2. **シンプル化**
   - color（色）機能を削除
   - description（説明）機能を削除
   - アイコン機能のみ保持

3. **変更検知の改善**
   - boardCategoryIdの変更だけでも保存可能に
   - hasContentChangesにboardCategoryId変更を含める

### 実装上の課題と解決

1. **WSL環境でのデータベース更新**
   - 問題：drizzle-kit pushがWSL環境で動作しない
   - 解決：Windows側でdb:pushを実行

2. **変更検知の不備**
   - 問題：カテゴリー変更だけでは保存されない
   - 解決：hasContentChangesとoriginalDataにboardCategoryIdを追加

## 今後の拡張可能性

### 短期的な改善

1. カテゴリーごとのタスク表示フィルター
2. カテゴリー別の進捗統計
3. カテゴリーのドラッグ&ドロップ並び替えUI

### 中長期的な拡張

1. カテゴリーのアイコン選択UI
2. カテゴリーテンプレート機能
3. カテゴリー間のタスク移動機能
4. カテゴリー別のデフォルト設定（優先度、ステータス等）

## 実装完了日

2025年8月16日
