# ボードアイコンちらつき問題の調査と対策

## 問題の概要

### 現象
- **メモ一覧**でボード紐付きメモAからボード紐付きメモBに移動する時
- **右側エディターの**ボードアイコンが一瞬グレー（bg-gray-100）になってから青（bg-light-Blue）に戻る
- **タスク一覧では**同じ操作をしてもちらつかない（実際にはタスクでもボード名表示OFF時にちらつく）

### 発生条件
- ボード紐付きアイテム → ボード紐付きアイテム の移動時
- コントロールパネルでボード名表示がOFFの時により顕著

## 根本原因の分析

### データ構造の問題
1. **メモ/タスク本体のデータ** (memos/tasksテーブル) - React Query キャッシュ
2. **ボード紐付け情報** (board_itemsテーブル) - 別クエリ、別キャッシュ

### アイテム切り替え時の処理フロー
1. メモ/タスクのデータは一覧キャッシュから即座に切り替わる
2. `useItemBoards('memo', memo?.id)`で新しいアイテムのボード情報を取得開始
3. **queryKey変更により前のボード情報がクリアされる**
4. 新しいボード情報が取得完了するまでボードアイコンがグレーになる

### ボード名表示切り替えの影響
- **ボード名表示OFF**: `useItemBoards('memo', showBoardName ? memo.id : undefined)`
- showBoardNameがfalseの時、各アイテムのボード情報を取得しない
- エディターでは常に取得するため、キャッシュにない状態でAPIリクエスト発生

## 実装した対策

### 1. プリフェッチ機能の追加
```typescript
// usePrefetchItemBoardsフックを追加
export function usePrefetchItemBoards(itemType: 'memo' | 'task', items: { id: number }[] | undefined) {
  return useQueries({
    queries: (items || []).map(item => ({
      queryKey: ["item-boards", itemType, item.id],
      queryFn: async () => { /* ボード情報取得 */ },
      enabled: !!items && items.length > 0,
      staleTime: 5 * 60 * 1000,  // 5分間キャッシュ
    }))
  });
}
```

### 2. メモ一覧でのプリフェッチ実装
```typescript
// memo-screen.tsx
const { data: memos } = useMemos();
// メモ一覧のボード情報をプリフェッチ（ちらつき防止）
usePrefetchItemBoards('memo', memos);
```

### 3. キャッシュ活用の修正
```typescript
// Before: showBoardName条件で取得を制御
const { data: boards } = useItemBoards('memo', showBoardName && !isDeleted ? Number(itemId) : undefined)

// After: 常にキャッシュから取得、表示のみ条件制御
const { data: boards } = useItemBoards('memo', !isDeleted ? Number(itemId) : undefined)
```

## 期待される効果
1. メモ一覧読み込み時に全メモのボード情報を一括プリフェッチ
2. アイテム選択時には既にキャッシュにボード情報が存在
3. ボード名表示切り替え時もキャッシュから即座に取得
4. ボードアイコンのちらつき解消

## 現在の状況
- 初期実装は完了（コミット: 2731340）
- まだちらつき問題は完全に解決していない
- 追加調査と対策が必要

## 次のステップ
1. 実際の動作確認
2. React Query DevToolsでのキャッシュ状態確認
3. 必要に応じて追加の最適化
   - `placeholderData: keepPreviousData`の活用
   - ボードアイコンコンポーネントの状態管理改善
   - より積極的なプリフェッチ戦略

## 参考：React Queryのキャッシュキー
- メモ一覧: `['memos']`
- タスク一覧: `['tasks']`  
- ボード情報: `["item-boards", itemType, itemId]`

各アイテムのボード情報が個別キャッシュのため、アイテム切り替え時にキャッシュミスが発生する構造的問題。